# CorrCLIPè®ºæ–‡è¯¦è§£

## 1. ç ”ç©¶èƒŒæ™¯ä¸é—®é¢˜

### 1.1 å¼€æ”¾è¯æ±‡è¯­ä¹‰åˆ†å‰²
- **ç›®æ ‡**ï¼šä¸ºå›¾åƒä¸­æ¯ä¸ªåƒç´ åˆ†é…è¯­ä¹‰æ ‡ç­¾ï¼Œä¸å±€é™äºé¢„å®šä¹‰ç±»åˆ«
- **æŒ‘æˆ˜**ï¼šéœ€è¦ç†è§£å¹¶åˆ†å‰²è®­ç»ƒæ—¶æœªè§è¿‡çš„ç‰©ä½“

### 1.2 CLIPæ¨¡å‹çš„ç‰¹ç‚¹ä¸å±€é™
- **ä¼˜åŠ¿**ï¼šä¼˜ç§€çš„é›¶æ ·æœ¬åˆ†ç±»èƒ½åŠ›
- **é—®é¢˜**ï¼šæ›´å…³æ³¨å…¨å±€è¯­ä¹‰ï¼Œå¿½ç•¥å±€éƒ¨ç»†èŠ‚ï¼Œç›´æ¥ç”¨äºåˆ†å‰²æ•ˆæœå·®

### 1.3 æ ¸å¿ƒå‘ç°
- **å…³é”®é—®é¢˜**ï¼šç±»é—´ç›¸å…³æ€§ï¼ˆä¸åŒç±»åˆ«å—ä¹‹é—´çš„å…³è”ï¼‰æŸå®³CLIPåˆ†å‰²æ€§èƒ½
- **å®éªŒè¯æ®**ï¼šé™åˆ¶å—äº¤äº’èŒƒå›´åœ¨åŒç±»åŒºåŸŸå†…èƒ½æ˜¾è‘—æå‡æ€§èƒ½

## 2. æ–¹æ³•æ•´ä½“æ¡†æ¶

```
è¾“å…¥å›¾åƒ â†’ CLIPè§†è§‰ç¼–ç å™¨ â†’ å—ç‰¹å¾
         â†’ SAM â†’ åŒºåŸŸæ©ç 
         â†’ ç›¸å…³æ€§é‡å»º â†’ æ”¹è¿›åˆ†å‰²
         â†’ ç‰¹å¾ç»†åŒ– â†’ å¢å¼ºè¡¨ç¤º
         â†’ å›¾æ ¡æ­£ â†’ æå‡ä¸€è‡´æ€§
```

## 3. ç®—æ³•åŸç†è¯¦è§£

### 3.1 åŸºç¡€æµç¨‹

#### 3.1.1 CLIPè§†è§‰ç¼–ç å™¨å¤„ç†
**å…¬å¼1ï¼šç›¸ä¼¼æ€§çŸ©é˜µè®¡ç®—**
```math
S = QQ^{\mathrm{T}}
```
**å…¬å¼è¯¦è§£**ï¼š
- `Q âˆˆ â„^{NÃ—d}`ï¼šæŸ¥è¯¢çŸ©é˜µï¼ŒNæ˜¯å—æ•°é‡ï¼Œdæ˜¯ç‰¹å¾ç»´åº¦
- `Q^T`ï¼šQçš„è½¬ç½®çŸ©é˜µ
- `S âˆˆ â„^{NÃ—N}`ï¼šç›¸ä¼¼æ€§çŸ©é˜µï¼Œæ¯ä¸ªå…ƒç´ S[i,j]è¡¨ç¤ºç¬¬iä¸ªå—ä¸ç¬¬jä¸ªå—çš„ç›¸ä¼¼åº¦
- **ä½œç”¨**ï¼šè®¡ç®—æ‰€æœ‰å—ä¹‹é—´çš„ç›¸å…³æ€§å¼ºåº¦

**å…¬å¼2ï¼šæ³¨æ„åŠ›è®¡ç®—**
```math
Attn = \text{Softmax}\left(\frac{S}{\sqrt{d}}\right)
```
**å…¬å¼è¯¦è§£**ï¼š
- `âˆšd`ï¼šç¼©æ”¾å› å­ï¼Œé˜²æ­¢Softmaxæ¢¯åº¦æ¶ˆå¤±
- `Softmax`ï¼šå°†ç›¸ä¼¼åº¦è½¬æ¢ä¸ºæ¦‚ç‡åˆ†å¸ƒï¼Œæ¯è¡Œå’Œä¸º1
- `Attn âˆˆ â„^{NÃ—N}`ï¼šæ³¨æ„åŠ›æƒé‡çŸ©é˜µ
- **ä½œç”¨**ï¼šç¡®å®šæ¯ä¸ªå—åº”è¯¥å…³æ³¨å…¶ä»–å—çš„æƒé‡

**å…¬å¼3ï¼šç‰¹å¾ç”Ÿæˆ**
```math
F_{img} = \text{Proj}(Attn \cdot V_C)
```
**å…¬å¼è¯¦è§£**ï¼š
- `V_C âˆˆ â„^{NÃ—d}`ï¼šå€¼çŸ©é˜µï¼ŒåŒ…å«æ¯ä¸ªå—çš„åŸå§‹ç‰¹å¾
- `Attn Â· V_C`ï¼šæ³¨æ„åŠ›åŠ æƒåçš„ç‰¹å¾
- `Proj`ï¼šæŠ•å½±å±‚ï¼Œè°ƒæ•´ç‰¹å¾ç»´åº¦
- `F_img âˆˆ â„^{NÃ—d}`ï¼šæœ€ç»ˆå›¾åƒå—ç‰¹å¾
- **ä½œç”¨**ï¼šç”Ÿæˆç”¨äºåˆ†å‰²çš„å—çº§ç‰¹å¾

#### 3.1.2 æ–‡æœ¬ç¼–ç ä¸åˆ†å‰²
**å…¬å¼4ï¼šåˆ†å‰²å›¾ç”Ÿæˆ**
```math
$$ pred = \underset{K}{\mathrm{arg\,max}}(\text{Proj}(F_{img})F^{T}_{text}) $$
```
**å…¬å¼è¯¦è§£**ï¼š
- `F_text âˆˆ â„^{KÃ—d}`ï¼šKä¸ªç±»åˆ«çš„æ–‡æœ¬åµŒå…¥
- `Proj(F_img) âˆˆ â„^{NÃ—d}`ï¼šæŠ•å½±åçš„å›¾åƒç‰¹å¾
- `Proj(F_img) Â· F_text^T âˆˆ â„^{NÃ—K}`ï¼šæ¯ä¸ªå—ä¸æ¯ä¸ªç±»åˆ«çš„ç›¸ä¼¼åº¦
- `argmax_K`ï¼šå¯¹æ¯ä¸ªå—é€‰æ‹©ç›¸ä¼¼åº¦æœ€é«˜çš„ç±»åˆ«
- **ä½œç”¨**ï¼šç”Ÿæˆåˆæ­¥çš„åˆ†å‰²ç»“æœ

### 3.2 èŒƒå›´é‡å»ºï¼ˆScope Reconstructionï¼‰

#### 3.2.1 æ©ç ç”Ÿæˆä¸åˆå¹¶
**å…¬å¼5ï¼šåŒºåŸŸç‰¹å¾è®¡ç®—**
```math
f_i = \text{Mean}(m_i \odot F_S)
```
**å…¬å¼è¯¦è§£**ï¼š
- `m_i âˆˆ â„^N`ï¼šç¬¬iä¸ªåŒºåŸŸæ©ç ï¼Œæ˜¯äºŒå€¼å‘é‡
- `âŠ™`ï¼šé€å…ƒç´ ç›¸ä¹˜ï¼ˆHadamardç§¯ï¼‰
- `F_S âˆˆ â„^{NÃ—d}`ï¼šè¯­ä¹‰ç‰¹å¾ï¼ˆæ¥è‡ªDINOï¼‰
- `Mean`ï¼šå¯¹æ©ç åŒºåŸŸå†…ç‰¹å¾æ±‚å¹³å‡
- `f_i âˆˆ â„^d`ï¼šç¬¬iä¸ªåŒºåŸŸçš„ç‰¹å¾è¡¨ç¤º
- **ä½œç”¨**ï¼šæå–æ¯ä¸ªåŒºåŸŸçš„ä»£è¡¨æ€§ç‰¹å¾

**å…¬å¼6ï¼šæ©ç åˆå¹¶**
```math
\hat{M} = \text{Cluster}(M, F_{region})
```
**å…¬å¼è¯¦è§£**ï¼š
- `M âˆˆ â„^{ZÃ—N}`ï¼šåŸå§‹Zä¸ªåŒºåŸŸæ©ç 
- `F_region âˆˆ â„^{ZÃ—d}`ï¼šæ‰€æœ‰åŒºåŸŸç‰¹å¾
- `Cluster`ï¼šèšç±»ç®—æ³•ï¼ˆDBSCANï¼‰
- `\hat{M} âˆˆ â„^{zÃ—N}`ï¼šåˆå¹¶åçš„zä¸ªåŒºåŸŸæ©ç 
- **ä½œç”¨**ï¼šåˆå¹¶è¯­ä¹‰ç›¸ä¼¼çš„åŒºåŸŸ

#### 3.2.2 äº¤äº’çŸ©é˜µæ„å»º
**å…¬å¼7ï¼šäº¤äº’çŸ©é˜µè®¡ç®—**
```math
$$ E = \sum_{i=1}^{z}\hat{m}_i \otimes \hat{m}_i + (m_0 \otimes m_0) \odot (S > \mu(S)) $$
```
**å…¬å¼è¯¦è§£**ï¼š
- `\hat{m}_i âˆˆ â„^N`ï¼šåˆå¹¶åçš„ç¬¬iä¸ªåŒºåŸŸæ©ç 
- `âŠ—`ï¼šå¤–ç§¯è¿ç®—ï¼Œ`\hat{m}_i âŠ— \hat{m}_i âˆˆ â„^{NÃ—N}`
- `m_0`ï¼šæœªåˆ†å‰²åŒºåŸŸæ©ç 
- `S > Mean(S)`ï¼šç›¸ä¼¼åº¦é«˜äºå¹³å‡å€¼çš„æ©ç 
- `âŠ™`ï¼šé€å…ƒç´ ç›¸ä¹˜
- `E âˆˆ â„^{NÃ—N}`ï¼šäº¤äº’çŸ©é˜µï¼Œ1è¡¨ç¤ºå…è®¸äº¤äº’ï¼Œ0è¡¨ç¤ºç¦æ­¢
- **ä½œç”¨**ï¼šå®šä¹‰å“ªäº›å—ä¹‹é—´å¯ä»¥ç›¸äº’å…³æ³¨

**ç¬¬ä¸€éƒ¨åˆ†**ï¼š`âˆ‘_{i=1}^z \hat{m}_i âŠ— \hat{m}_i`
- åŒä¸€åŒºåŸŸå†…çš„å—å¯ä»¥å®Œå…¨äº¤äº’
- å¤–ç§¯ç»“æœï¼šå¦‚æœå—iå’Œå—jéƒ½åœ¨åŒºåŸŸkå†…ï¼Œåˆ™E[i,j]=1

**ç¬¬äºŒéƒ¨åˆ†**ï¼š`(m_0 âŠ— m_0) âŠ™ (S > Mean(S))`
- æœªåˆ†å‰²åŒºåŸŸä¸­ï¼Œåªæœ‰é«˜ç›¸ä¼¼åº¦çš„å—å¯ä»¥äº¤äº’
- æä¾›ä¸€å®šçš„çµæ´»æ€§ï¼Œé˜²æ­¢è¿‡åº¦çº¦æŸ

#### 3.2.3 æ©ç æ³¨æ„åŠ›
**å…¬å¼8ï¼šæ©ç Softmax**
```math
Attn = \text{Masked Softmax}\left(\frac{S}{\sqrt{d}},\; E\right)
```
**å…¬å¼è¯¦è§£**ï¼š
- `Masked Softmax`ï¼šåªåœ¨E=1çš„ä½ç½®è®¡ç®—Softmaxï¼Œå…¶ä»–ä½ç½®ä¸º0
- `S/âˆšd`ï¼šç¼©æ”¾åçš„ç›¸ä¼¼æ€§çŸ©é˜µ
- **ä½œç”¨**ï¼šå®ç°èŒƒå›´é™åˆ¶çš„æ³¨æ„åŠ›æœºåˆ¶

### 3.3 å€¼é‡å»ºï¼ˆValue Reconstructionï¼‰

**å…¬å¼9ï¼šDINOç›¸ä¼¼æ€§è®¡ç®—**
```math
S = \frac{F_S F_S^{\mathrm{T}}}{\|F_S\|^2} = \frac{(Q_D + K_D)(Q_D + K_D)^{\mathrm{T}}}{\|Q_D + K_D\|^2}
```
**å…¬å¼è¯¦è§£**ï¼š
- `Q_D, K_D âˆˆ â„^{NÃ—d}`ï¼šDINOçš„æŸ¥è¯¢å’Œé”®çŸ©é˜µ
- `F_S = Q_D + K_D`ï¼šç»„åˆåçš„è¯­ä¹‰ç‰¹å¾
- `F_S F_S^T`ï¼šç‰¹å¾ç›¸ä¼¼æ€§çŸ©é˜µ
- `â€–F_Sâ€–^2`ï¼šç‰¹å¾çš„L2èŒƒæ•°å¹³æ–¹ï¼Œç”¨äºå½’ä¸€åŒ–
- `S âˆˆ â„^{NÃ—N}`ï¼šå½’ä¸€åŒ–çš„ç›¸ä¼¼æ€§çŸ©é˜µ
- **ä½œç”¨**ï¼šåˆ©ç”¨DINOçš„è¯­ä¹‰ç†è§£æä¾›æ›´å‡†ç¡®çš„ç›¸ä¼¼æ€§è®¡ç®—

**å…¬å¼10ï¼šé”åŒ–æ³¨æ„åŠ›**
```math
Attn = \text{Masked Softmax}\left(\frac{S}{\tau},\; E\right)
```
**å…¬å¼è¯¦è§£**ï¼š
- `Ï„ = 0.25`ï¼šæ¸©åº¦å‚æ•°ï¼Œå°äº1
- `S/Ï„`ï¼šæ”¾å¤§ç›¸ä¼¼åº¦å·®å¼‚
- **ä½œç”¨**ï¼šä½¿æ³¨æ„åŠ›åˆ†å¸ƒæ›´å°–é”ï¼Œå…³æ³¨æœ€é‡è¦çš„ç›¸å…³æ€§

### 3.4 ç‰¹å¾ç»†åŒ–ï¼ˆFeature Refinementï¼‰

**å…¬å¼11ï¼šå¤šåˆ†æ”¯ç‰¹å¾èåˆ**
```math
$$ F_{img} = \mathrm{Proj}(AttnV_C) + \alpha \cdot \mathrm{Proj}(AttnV_C^{\prime}) + \beta \cdot MCT $$
```
**å…¬å¼è¯¦è§£**ï¼š

**ç¬¬ä¸€é¡¹**ï¼š`Proj(Attn V_C)`
- ä¸»åˆ†æ”¯ï¼šåŸºç¡€è¯­ä¹‰ç‰¹å¾
- `Attn`ï¼šé‡å»ºåçš„æ³¨æ„åŠ›æƒé‡
- `V_C`ï¼šCLIPçš„å€¼å‘é‡

**ç¬¬äºŒé¡¹**ï¼š`Î± * Proj(Attn V_Câ€²)`
- ç©ºé—´åˆ†æ”¯ï¼šå¢å¼ºç©ºé—´ç»†èŠ‚
- `V_Câ€²`ï¼šCLIPè¾ƒä½å±‚çš„ç‰¹å¾ï¼ˆå¯Œå«ç©ºé—´ä¿¡æ¯ï¼‰
- `Î± = 1.0`ï¼šå¹³è¡¡ç³»æ•°

**ç¬¬ä¸‰é¡¹**ï¼š`Î² * MCT`
- è¯­ä¹‰åˆ†æ”¯ï¼šå¢å¼ºè¯­ä¹‰è¡¨ç¤º
- `MCT`ï¼šæ©ç ç±»åˆ«æ ‡è®°
- `Î² = 0.5`ï¼šå¹³è¡¡ç³»æ•°

**æ•´ä½“ä½œç”¨**ï¼šä»å¤šä¸ªå±‚é¢æå‡ç‰¹å¾è´¨é‡

### 3.5 å›¾æ ¡æ­£ï¼ˆMap Correctionï¼‰

**å…¬å¼12ï¼šåŒºåŸŸä¸€è‡´æ€§æ ¡æ­£**
```math
$$ pred[m_i] = \mathrm{Mode}(pred[m_i]),\quad i>0 $$
```
**å…¬å¼è¯¦è§£**ï¼š
- `pred[m_i]`ï¼šç¬¬iä¸ªåŒºåŸŸå†…çš„æ‰€æœ‰é¢„æµ‹ç»“æœ
- `Mode`ï¼šä¼—æ•°è¿ç®—ï¼Œæ‰¾å‡ºæœ€å¸¸è§çš„ç±»åˆ«
- `pred[m_i] = Mode(...)`ï¼šå°†åŒºåŸŸå†…æ‰€æœ‰é¢„æµ‹æ”¹ä¸ºä¼—æ•°ç±»åˆ«
- **ä½œç”¨**ï¼šå¼ºåˆ¶åŒä¸€åŒºåŸŸå†…çš„é¢„æµ‹ä¸€è‡´æ€§

## 4. å…³é”®æŠ€æœ¯ä¼˜åŠ¿

### 4.1 èŒƒå›´é‡å»ºçš„ä¼˜åŠ¿
- **ç²¾ç¡®æ§åˆ¶**ï¼šé€šè¿‡æ•°å­¦å…¬å¼ç²¾ç¡®é™åˆ¶äº¤äº’èŒƒå›´
- **çµæ´»æ€§**ï¼šæœªåˆ†å‰²åŒºåŸŸä¿ç•™ä¸€å®šçš„äº¤äº’èƒ½åŠ›
- **å¯è§£é‡Šæ€§**ï¼šäº¤äº’çŸ©é˜µEæ˜ç¡®è¡¨ç¤ºå…è®¸çš„äº¤äº’æ¨¡å¼

### 4.2 å€¼é‡å»ºçš„æ”¹è¿›
- **è¯­ä¹‰ä¸€è‡´æ€§**ï¼šDINOæä¾›æ›´å¥½çš„è¯­ä¹‰å¸ƒå±€ç†è§£
- **æ•°å€¼ç¨³å®šæ€§**ï¼šå½’ä¸€åŒ–é˜²æ­¢æ•°å€¼æº¢å‡º
- **åˆ†å¸ƒé”åŒ–**ï¼šæ¸©åº¦å‚æ•°å¢å¼ºé‡è¦ç›¸å…³æ€§

### 4.3 ç‰¹å¾ç»†åŒ–çš„å¤šå°ºåº¦èåˆ
- **ä¸»åˆ†æ”¯**ï¼šä¿æŒåŸºç¡€è¯­ä¹‰
- **ç©ºé—´åˆ†æ”¯**ï¼šè¡¥å……ç»†èŠ‚ä¿¡æ¯
- **è¯­ä¹‰åˆ†æ”¯**ï¼šå¢å¼ºç±»åˆ«åŒºåˆ†

## 5. å®éªŒæ•ˆæœ

### 5.1 æ€§èƒ½å¯¹æ¯”
| æ–¹æ³• | å¹³å‡mIoU | ç›¸å¯¹æå‡ |
|------|----------|----------|
| åŸå§‹CLIP | 10.1% | - |
| ä¹‹å‰æœ€ä½³ | 48.6% | - |
| CorrCLIP | 53.6% | +5.0% |

### 5.2 å„ç»„ä»¶è´¡çŒ®
| ç»„ä»¶ | VOC21 | PC60 | Object | å¹³å‡æå‡ |
|------|-------|------|--------|----------|
| åŸºç¡€CLIP | 51.8 | 32.6 | 33.0 | - |
| +èŒƒå›´é‡å»º | 68.1 | 39.6 | 41.5 | +14.5% |
| +å€¼é‡å»º | 68.5 | 40.3 | 42.0 | +0.8% |
| +ç‰¹å¾ç»†åŒ– | 72.5 | 42.0 | 43.7 | +3.0% |
| +å›¾æ ¡æ­£ | 74.8 | 44.2 | 43.7 | +1.3% |

## 6. æ€»ç»“

CorrCLIPé€šè¿‡ç³»ç»Ÿçš„æ•°å­¦å»ºæ¨¡è§£å†³äº†CLIPåœ¨åˆ†å‰²ä»»åŠ¡ä¸­çš„æ ¸å¿ƒé—®é¢˜ï¼š

1. **é—®é¢˜è¯Šæ–­**ï¼šæ˜ç¡®ç±»é—´ç›¸å…³æ€§æ˜¯æ€§èƒ½ç“¶é¢ˆ
2. **æ•°å­¦è§£å†³æ–¹æ¡ˆ**ï¼š
   - **èŒƒå›´é‡å»º**ï¼šç”¨æ©ç å¤–ç§¯æ„å»ºäº¤äº’çº¦æŸ
   - **å€¼é‡å»º**ï¼šç”¨DINOç‰¹å¾æ”¹è¿›ç›¸ä¼¼æ€§è®¡ç®—
   - **ç‰¹å¾ç»†åŒ–**ï¼šå¤šåˆ†æ”¯åŠ æƒèåˆå¢å¼ºè¡¨ç¤º
   - **å›¾æ ¡æ­£**ï¼šä¼—æ•°è¿ç®—å¼ºåˆ¶ç©ºé—´ä¸€è‡´æ€§
3. **å®éªŒéªŒè¯**ï¼šåœ¨å¤šä¸ªåŸºå‡†ä¸Šå®ç°æ˜¾è‘—æå‡

è¿™ç§æ–¹æ³•ä¸ä»…æå‡äº†æ€§èƒ½ï¼Œè¿˜ä¸ºç†è§£åŸºç¡€æ¨¡å‹çš„è¡Œä¸ºæä¾›äº†æ–°çš„è§†è§’ã€‚

# CLIPæ–‡æœ¬ç¼–ç ä¸ç‰¹å¾å¯¹é½è¯¦è§£

## 1. æ•´ä½“æµç¨‹æ¦‚è¿°

è¿™éƒ¨åˆ†æè¿°äº†ä»ç±»åˆ«åç§°åˆ°æœ€ç»ˆåˆ†å‰²å›¾çš„å®Œæ•´è¿‡ç¨‹ï¼š

```
ç±»åˆ«åç§° â†’ æ–‡æœ¬æç¤ºæ„å»º â†’ CLIPæ–‡æœ¬ç¼–ç  â†’ ç±»åˆ«åµŒå…¥ â†’ ç‰¹å¾ç©ºé—´å¯¹é½ â†’ åˆ†å‰²é¢„æµ‹
```

## 2. è¯¦ç»†æ­¥éª¤åˆ†è§£

### 2.1 æ–‡æœ¬æç¤ºæ„å»º

**è¾“å…¥**ï¼šKä¸ªç±»åˆ«åç§°ï¼ˆå¦‚ï¼š"dog", "cat", "car"ç­‰ï¼‰

**å¤„ç†è¿‡ç¨‹**ï¼š
```python
# ä½¿ç”¨æ ‡å‡†ImageNetæç¤ºæ¨¡æ¿
template = "a photo of a {}"

# ä¸ºæ¯ä¸ªç±»åˆ«æ„å»ºæè¿°
category_descriptions = []
for class_name in class_names:
    description = template.format(class_name)  # å¦‚ï¼š"a photo of a dog"
    category_descriptions.append(description)
```

**ä¸ºä»€ä¹ˆéœ€è¦æç¤ºæ¨¡æ¿ï¼Ÿ**
- æä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæå‡åˆ†ç±»å‡†ç¡®æ€§
- CLIPåœ¨è®­ç»ƒæ—¶ä½¿ç”¨äº†ç±»ä¼¼çš„æ–‡æœ¬æ ¼å¼
- å¸®åŠ©æ¨¡å‹æ›´å¥½åœ°ç†è§£ç±»åˆ«æ¦‚å¿µ

### 2.2 æ–‡æœ¬ç¼–ç è¿‡ç¨‹

**å…¬å¼è¡¨ç¤º**ï¼š
```math
F_{text} = \text{TextEncoder}(\text{[prompt}_1, \text{prompt}_2, ..., \text{prompt}_K])
```

**ç»´åº¦è¯´æ˜**ï¼š
- è¾“å…¥ï¼šKä¸ªæ–‡æœ¬æç¤ºï¼Œæ¯ä¸ªæç¤ºæ˜¯å­—ç¬¦ä¸²
- è¾“å‡ºï¼š`F_text âˆˆ â„^{KÃ—d}`
  - Kï¼šç±»åˆ«æ•°é‡
  - dï¼šç‰¹å¾ç»´åº¦ï¼ˆä¸å›¾åƒç‰¹å¾ç»´åº¦ç›¸åŒï¼Œå¦‚512ï¼‰
  - æ¯ä¸€è¡Œ `F_text[i]` å¯¹åº”ç¬¬iä¸ªç±»åˆ«çš„åµŒå…¥å‘é‡

### 2.3 å…³é”®æ¦‚å¿µè¯¦è§£ï¼š"ç‰¹å¾ç©ºé—´å¯¹é½"

#### 2.3.1 ä»€ä¹ˆæ˜¯ç‰¹å¾ç©ºé—´å¯¹é½ï¼Ÿ

**é—®é¢˜èƒŒæ™¯**ï¼š
- å›¾åƒç‰¹å¾ `F_img âˆˆ â„^{NÃ—d}` æ¥è‡ªCLIPè§†è§‰ç¼–ç å™¨
- æ–‡æœ¬ç‰¹å¾ `F_text âˆˆ â„^{KÃ—d}` æ¥è‡ªCLIPæ–‡æœ¬ç¼–ç å™¨
- è™½ç„¶ç»´åº¦ç›¸åŒï¼Œä½†å¯èƒ½å­˜åœ¨äºä¸åŒçš„ç‰¹å¾ç©ºé—´ä¸­

**å¯¹é½çš„å¿…è¦æ€§**ï¼š
```math
\text{ç›¸ä¼¼åº¦} = F_{img} \cdot F_{text}^T
```
å¦‚æœä¸¤ä¸ªç‰¹å¾ç©ºé—´æ²¡æœ‰å¯¹é½ï¼Œç‚¹ç§¯è¿ç®—æ²¡æœ‰æ„ä¹‰ï¼

#### 2.3.2 æŠ•å½±å±‚çš„ä½œç”¨

**å…¬å¼è¡¨ç¤º**ï¼š
```math
F_{img}^{proj} = \text{Proj}(F_{img}) = F_{img} \cdot W + b
```

**å‚æ•°è¯´æ˜**ï¼š
- `W âˆˆ â„^{dÃ—d}`ï¼šæŠ•å½±æƒé‡çŸ©é˜µ
- `b âˆˆ â„^d`ï¼šåç½®å‘é‡
- `F_img^{proj} âˆˆ â„^{NÃ—d}`ï¼šæŠ•å½±åçš„å›¾åƒç‰¹å¾

**æŠ•å½±å±‚çš„å…·ä½“åŠŸèƒ½**ï¼š
1. **ç©ºé—´å˜æ¢**ï¼šå°†å›¾åƒç‰¹å¾æ—‹è½¬/ç¼©æ”¾ä»¥åŒ¹é…æ–‡æœ¬ç‰¹å¾ç©ºé—´
2. **åˆ†å¸ƒè°ƒæ•´**ï¼šä½¿ä¸¤ç§æ¨¡æ€çš„ç‰¹å¾åˆ†å¸ƒæ›´åŠ ä¸€è‡´
3. **è¯­ä¹‰å¯¹é½**ï¼šç¡®ä¿ç›¸ä¼¼çš„è¯­ä¹‰æ¦‚å¿µåœ¨ç‰¹å¾ç©ºé—´ä¸­æ¥è¿‘

#### 2.3.3 ä¸ºä»€ä¹ˆéœ€è¦æŠ•å½±ï¼Ÿ

**CLIPè®­ç»ƒç‰¹æ€§**ï¼š
- CLIPé€šè¿‡å¯¹æ¯”å­¦ä¹ è®­ç»ƒï¼Œä½†å›¾åƒå’Œæ–‡æœ¬ç¼–ç å™¨æ˜¯åˆ†å¼€çš„
- è®­ç»ƒæ—¶å­˜åœ¨ä¸€ä¸ªæŠ•å½±å±‚æ¥å¯¹é½ä¸¤ç§æ¨¡æ€
- åœ¨æ¨ç†æ—¶ï¼Œè¿™ä¸ªæŠ•å½±å±‚è¢«ä¿ç•™ç”¨äºç‰¹å¾å¯¹é½

**æ•°å­¦è§£é‡Š**ï¼š
```math
\text{åŸå§‹ç©ºé—´ï¼š} F_{img} \in \mathcal{V}, F_{text} \in \mathcal{T}
\text{ç›®æ ‡ï¼š} \mathcal{V} \rightarrow \mathcal{T}
\text{é€šè¿‡ï¼š} F_{img}^{proj} = \text{Proj}(F_{img}) \in \mathcal{T}
```

### 2.4 åˆ†å‰²å›¾ç”Ÿæˆ

#### 2.4.1 ç›¸ä¼¼åº¦è®¡ç®—

**å…¬å¼é‡å†™**ï¼š
```math
\text{Similarity} = \text{Proj}(F_{img}) \cdot F_{text}^T
```

**ç»´åº¦åˆ†æ**ï¼š
- `Proj(F_img) âˆˆ â„^{NÃ—d}`
- `F_text^T âˆˆ â„^{dÃ—K}`
- `Similarity âˆˆ â„^{NÃ—K}`

**ç‰©ç†æ„ä¹‰**ï¼š
- ç›¸ä¼¼åº¦çŸ©é˜µçš„æ¯ä¸ªå…ƒç´  `Similarity[i,j]` è¡¨ç¤ºï¼š
  - ç¬¬iä¸ªå›¾åƒå—ä¸ç¬¬jä¸ªç±»åˆ«çš„åŒ¹é…ç¨‹åº¦
  - æ•°å€¼è¶Šå¤§ï¼Œè¡¨ç¤ºè¯¥å—è¶Šå¯èƒ½å±äºè¯¥ç±»åˆ«

#### 2.4.2 æœ€ç»ˆé¢„æµ‹

**å…¬å¼**ï¼š
```math
pred = \mathrm*{arg\,max}_{K}(\text{Similarity})
```

**æ“ä½œè¯´æ˜**ï¼š
```python
# å¯¹æ¯ä¸ªå›¾åƒå—ï¼ˆæ¯è¡Œï¼‰è¿›è¡Œæ“ä½œ
for i in range(N):  # Nä¸ªå›¾åƒå—
    class_id = argmax(Similarity[i])  # æ‰¾åˆ°æœ€å¤§ç›¸ä¼¼åº¦å¯¹åº”çš„ç±»åˆ«
    pred[i] = class_id
```

**ç»“æœ**ï¼š
- `pred âˆˆ â„•^N`ï¼šæ¯ä¸ªå›¾åƒå—çš„é¢„æµ‹ç±»åˆ«ID
- æœ€ç»ˆå¯ä»¥reshapeæˆ2Dåˆ†å‰²å›¾

## 3. æŠ€æœ¯ç»†èŠ‚æ·±å…¥

### 3.1 æŠ•å½±å±‚çš„è®­ç»ƒæ–¹å¼

**åœ¨CLIPé¢„è®­ç»ƒä¸­**ï¼š
```math
\mathcal{L} = -\frac{1}{B}\sum_{i=1}^B \log\frac{\exp(\text{Proj}(F_{img}^i) \cdot F_{text}^i / \tau)}{\sum_{j=1}^B \exp(\text{Proj}(F_{img}^i) \cdot F_{text}^j / \tau)}
```

**è§£é‡Š**ï¼š
- å¯¹æ¯”å­¦ä¹ æŸå¤±å‡½æ•°
- é¼“åŠ±åŒ¹é…çš„å›¾åƒ-æ–‡æœ¬å¯¹æœ‰é«˜ç›¸ä¼¼åº¦
- æŠ•å½±å±‚åœ¨æ­¤è¿‡ç¨‹ä¸­å­¦ä¹ å¯¹é½ä¸¤ç§æ¨¡æ€

### 3.2 ç‰¹å¾ç©ºé—´å¯¹é½çš„æ•°å­¦æ„ä¹‰

**ç†æƒ³æƒ…å†µ**ï¼š
```math
\text{Proj}(F_{img}[dog\ patch]) \approx F_{text}["dog"]
\text{Proj}(F_{img}[cat\ patch]) \approx F_{text}["cat"]
```

**å®é™…å®ç°**ï¼š
- æŠ•å½±å±‚å­¦ä¹ ä¸€ä¸ªçº¿æ€§å˜æ¢
- å°†è§†è§‰ç‰¹å¾ç©ºé—´æ˜ å°„åˆ°æ–‡æœ¬ç‰¹å¾ç©ºé—´
- ä½¿è¯­ä¹‰ç›¸å…³çš„æ¦‚å¿µåœ¨åµŒå…¥ç©ºé—´ä¸­æ¥è¿‘

### 3.3 åœ¨CorrCLIPä¸­çš„å…·ä½“åº”ç”¨

**ç»“åˆå‰é¢çš„æ”¹è¿›**ï¼š
```math
F_{img}^{final} = \text{Proj}(AttnV_C) + \alpha \cdot \text{Proj}(AttnV_C^{\prime}) + \beta \cdot MCT
```

**ç„¶å**ï¼š
```math
\text{Similarity} = F_{img}^{final} \cdot F_{text}^T
```

**åˆ›æ–°ç‚¹**ï¼š
- åœ¨ç›¸å…³æ€§é‡å»ºå’Œç‰¹å¾ç»†åŒ–ä¹‹åè¿›è¡Œå¯¹é½
- ä½¿ç”¨æ”¹è¿›åçš„ç‰¹å¾è¿›è¡Œæœ€ç»ˆåˆ†ç±»
- æŠ•å½±å±‚ä½œç”¨äºå¢å¼ºåçš„ç‰¹å¾

## 4. æ€»ç»“

è¿™ä¸ªéƒ¨åˆ†çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š

1. **æ–‡æœ¬ç¼–ç **ï¼šå°†ç±»åˆ«åç§°è½¬æ¢ä¸ºæœ‰æ„ä¹‰çš„æ–‡æœ¬åµŒå…¥
2. **ç©ºé—´å¯¹é½**ï¼šé€šè¿‡æŠ•å½±å±‚ç¡®ä¿å›¾åƒå’Œæ–‡æœ¬ç‰¹å¾åœ¨åŒä¸€ä¸ªè¯­ä¹‰ç©ºé—´
3. **ç›¸ä¼¼åº¦è®¡ç®—**ï¼šåœ¨å¯¹é½çš„ç©ºé—´ä¸­è¿›è¡Œæœ‰æ„ä¹‰çš„æ¯”è¾ƒ
4. **åˆ†ç±»å†³ç­–**ï¼šåŸºäºç›¸ä¼¼åº¦ä¸ºæ¯ä¸ªå›¾åƒå—åˆ†é…æœ€å¯èƒ½çš„ç±»åˆ«

è¿™ç§è®¾è®¡ä½¿å¾—CLIPèƒ½å¤Ÿï¼š
- ç†è§£ä»»æ„æ–‡æœ¬æè¿°çš„ç±»åˆ«
- åœ¨å…±äº«çš„è¯­ä¹‰ç©ºé—´ä¸­æ¯”è¾ƒè§†è§‰å’Œæ–‡æœ¬æ¦‚å¿µ
- å®ç°çœŸæ­£çš„å¼€æ”¾è¯æ±‡åˆ†å‰²èƒ½åŠ›


# CorrCLIPè®ºæ–‡è¯„ä»·æŒ‡æ ‡è¯¦ç»†åˆ†æ

## 1. ä¸»è¦è¯„ä»·æŒ‡æ ‡ï¼šmIoUï¼ˆå¹³å‡äº¤å¹¶æ¯”ï¼‰

### 1.1 mIoUåŸºæœ¬å®šä¹‰

**æ•°å­¦å…¬å¼**ï¼š
```math
\text{mIoU} = \frac{1}{K} \sum_{i=1}^{K} \frac{TP_i}{TP_i + FP_i + FN_i}
```

**åˆ†é‡è§£é‡Š**ï¼š
- `K`ï¼šç±»åˆ«æ€»æ•°
- `TP_i`ï¼ˆTrue Positiveï¼‰ï¼šæ­£ç¡®é¢„æµ‹ä¸ºç±»åˆ«içš„åƒç´ æ•°
- `FP_i`ï¼ˆFalse Positiveï¼‰ï¼šé”™è¯¯é¢„æµ‹ä¸ºç±»åˆ«içš„åƒç´ æ•°
- `FN_i`ï¼ˆFalse Negativeï¼‰ï¼šå®é™…æ˜¯ç±»åˆ«iä½†é¢„æµ‹é”™è¯¯çš„åƒç´ æ•°

### 1.2 åœ¨è¯­ä¹‰åˆ†å‰²ä¸­çš„å…·ä½“è®¡ç®—

**æ¯ä¸ªç±»åˆ«çš„IoUè®¡ç®—**ï¼š
```python
# å¯¹äºæ¯ä¸ªç±»åˆ«i
intersection = (pred == i) & (gt == i)  # é¢„æµ‹å’ŒçœŸå®å€¼éƒ½ä¸ºiçš„åƒç´ 
union = (pred == i) | (gt == i)         # é¢„æµ‹æˆ–çœŸå®å€¼ä¸ºiçš„åƒç´ 

IoU_i = intersection.sum() / union.sum()
```

**mIoUè®¡ç®—**ï¼š
```python
mIoU = 0
for i in range(K):  # éå†æ‰€æœ‰ç±»åˆ«
    mIoU += IoU_i
mIoU /= K  # å¯¹æ‰€æœ‰ç±»åˆ«å–å¹³å‡
```

## 2. è®ºæ–‡ä¸­ä½¿ç”¨çš„å…«ä¸ªåŸºå‡†æµ‹è¯•

### 2.1 æ•°æ®é›†ç»Ÿè®¡ä¸ç‰¹ç‚¹

| æ•°æ®é›† | å›¾åƒæ•°é‡ | ç±»åˆ«æ•° | èƒŒæ™¯ç±» | æ•°æ®ç‰¹ç‚¹ |
|--------|----------|--------|--------|----------|
| Pascal VOC21 | 1,449 | 21 | åŒ…å« | é€šç”¨ç‰©ä½“ï¼ŒèƒŒæ™¯ä½œä¸ºç‹¬ç«‹ç±»åˆ« |
| Pascal VOC20 | 1,449 | 20 | ä¸åŒ…å« | é€šç”¨ç‰©ä½“ï¼Œå¿½ç•¥èƒŒæ™¯ |
| Pascal Context60 | 5,104 | 60 | åŒ…å« | åœºæ™¯ç†è§£ï¼ŒåŒ…å«ç‰©ä½“å’Œåœºæ™¯å…ƒç´  |
| Pascal Context59 | 5,104 | 59 | ä¸åŒ…å« | åœºæ™¯ç†è§£ï¼Œå¿½ç•¥èƒŒæ™¯ |
| COCO Stuff | 5,000 | 171 | åŒ…å« | ä¸°å¯Œçš„äº‹ç‰©å’Œææ–™ç±»åˆ« |
| COCO Object | 5,000 | 81 | åŒ…å« | ç‰©ä½“ç±»åˆ«ï¼Œäº‹ç‰©ç±»åˆå¹¶ä¸ºèƒŒæ™¯ |
| ADE20k | 2,000 | 150 | ä¸åŒ…å« | å¤æ‚å®¤å†…å¤–åœºæ™¯ |
| Cityscapes | 500 | 19 | ä¸åŒ…å« | åŸå¸‚è¡—æ™¯ï¼Œè‡ªåŠ¨é©¾é©¶åœºæ™¯ |

### 2.2 æ•°æ®é›†é€‰æ‹©çš„ç­–ç•¥æ„ä¹‰

**å¤šæ ·æ€§è¦†ç›–**ï¼š
- **è§„æ¨¡å·®å¼‚**ï¼šä»500åˆ°5,104å¼ å›¾åƒ
- **ç±»åˆ«å¤æ‚åº¦**ï¼šä»19åˆ°171ä¸ªç±»åˆ«
- **åœºæ™¯ç±»å‹**ï¼šé€šç”¨ç‰©ä½“â†’å®¤å†…åœºæ™¯â†’è¡—æ™¯
- **èƒŒæ™¯å¤„ç†**ï¼šåŒ…å«/ä¸åŒ…å«èƒŒæ™¯çš„ä¸åŒè®¾ç½®

**è¯„ä¼°å…¨é¢æ€§**ï¼š
- æµ‹è¯•æ¨¡å‹åœ¨ä¸åŒå¤æ‚åº¦ä¸‹çš„è¡¨ç°
- éªŒè¯å¯¹èƒŒæ™¯å¤„ç†çš„é²æ£’æ€§
- è¯„ä¼°åœ¨çœŸå®åœºæ™¯ï¼ˆCityscapesï¼‰çš„å®ç”¨æ€§

## 3. è¯„ä»·æŒ‡æ ‡çš„æŠ€æœ¯ç»†èŠ‚

### 3.1 mIoUåœ¨å¼€æ”¾è¯æ±‡åˆ†å‰²ä¸­çš„ç‰¹æ®Šæ€§

**ä¼ ç»Ÿåˆ†å‰² vs å¼€æ”¾è¯æ±‡åˆ†å‰²**ï¼š
```python
# ä¼ ç»Ÿåˆ†å‰² - å›ºå®šç±»åˆ«é›†åˆ
known_classes = ["dog", "cat", "car"]  # è®­ç»ƒæ—¶å·²çŸ¥

# å¼€æ”¾è¯æ±‡åˆ†å‰² - åŠ¨æ€ç±»åˆ«é›†åˆ
test_classes = ["elephant", "giraffe"]  # è®­ç»ƒæ—¶æœªçŸ¥
```

**è¯„ä»·æŒ‘æˆ˜**ï¼š
- éœ€è¦åœ¨æœªè§è¿‡çš„ç±»åˆ«ä¸Šè¯„ä¼°æ€§èƒ½
- ç±»åˆ«æ•°é‡åœ¨æµ‹è¯•æ—¶å¯èƒ½å˜åŒ–
- éœ€è¦å…¬å¹³æ¯”è¾ƒä¸åŒæ–¹æ³•çš„æ³›åŒ–èƒ½åŠ›

### 3.2 è®ºæ–‡ä¸­çš„è¯„ä»·åè®®

**è®­ç»ƒè‡ªç”±æ–¹æ³•çš„å…¬å¹³æ¯”è¾ƒ**ï¼š
```python
# æ‰€æœ‰æ¯”è¾ƒæ–¹æ³•ä½¿ç”¨ç›¸åŒçš„ï¼š
# 1. CLIPæ¨¡å‹æƒé‡
# 2. æ–‡æœ¬æç¤ºæ¨¡æ¿
# 3. é¢„å¤„ç†æµç¨‹
# 4. è¯„ä»·ä»£ç 
```

**æ•°æ®é›†åˆ’åˆ†**ï¼š
- ä½¿ç”¨æ ‡å‡†çš„éªŒè¯é›†ï¼ˆéæµ‹è¯•é›†ï¼‰
- ç¡®ä¿ç»“æœå¯å¤ç°
- é¿å…è¿‡æ‹Ÿåˆæµ‹è¯•é›†

## 4. ç»“æœåˆ†æä¸æŒ‡æ ‡è§£è¯»

### 4.1 æ€§èƒ½æå‡çš„ç»Ÿè®¡æ˜¾è‘—æ€§

**ä»Table 1çš„æ•°æ®åˆ†æ**ï¼š

| CLIPç‰ˆæœ¬ | ä¹‹å‰æœ€ä½³ | CorrCLIP | ç»å¯¹æå‡ | ç›¸å¯¹æå‡ |
|----------|----------|----------|----------|----------|
| ViT-B/16 | 45.8% | 51.0% | +5.2% | +11.4% |
| ViT-L/14 | 45.2% | 53.6% | +8.4% | +18.6% |
| ViT-H/14 | 48.6% | 52.3% | +3.7% | +7.6% |

**å…³é”®è§‚å¯Ÿ**ï¼š
- ViT-L/14æå‡æœ€æ˜¾è‘—ï¼ˆ+8.4%ï¼‰
- å¤§æ¨¡å‹ï¼ˆViT-H/14ï¼‰æå‡ç›¸å¯¹è¾ƒå°ï¼Œä½†åŸºæ•°æ›´é«˜
- æ‰€æœ‰è§„æ¨¡æ¨¡å‹éƒ½æ˜¾è‘—è¶…è¶Šä¹‹å‰æ–¹æ³•

### 4.2 è·¨æ•°æ®é›†ä¸€è‡´æ€§åˆ†æ

**æ€§èƒ½æå‡çš„åˆ†å¸ƒ**ï¼š

| æ•°æ®é›† | ViT-B/16æå‡ | éš¾åº¦çº§åˆ« | æå‡åŸå› åˆ†æ |
|--------|--------------|----------|--------------|
| VOC21 | +7.7% | ç®€å• | ç‰©ä½“è¾¹ç•Œæ¸…æ™°ï¼ŒèŒƒå›´é‡å»ºæ•ˆæœæ˜¾è‘— |
| PC60 | +5.6% | ä¸­ç­‰ | åœºæ™¯å¤æ‚ï¼Œç‰¹å¾ç»†åŒ–å‘æŒ¥ä½œç”¨ |
| Object | -1.1% | ä¸­ç­‰ | åŸºæ•°é«˜ï¼Œæå‡ç©ºé—´æœ‰é™ |
| ADE | +5.0% | å›°éš¾ | å¤æ‚åœºæ™¯ï¼Œå¤šç»„ä»¶ååŒä½œç”¨ |
| City | +6.5% | å›°éš¾ | ç»“æ„åŒ–åœºæ™¯ï¼Œå›¾æ ¡æ­£æ•ˆæœæ˜æ˜¾ |

**è´Ÿæå‡åˆ†æ**ï¼š
- COCO Objectå‡ºç°-1.1%çš„å¾®å°ä¸‹é™
- å¯èƒ½åŸå› ï¼šè¯¥æ•°æ®é›†å°†äº‹ç‰©ç±»åˆå¹¶ä¸ºèƒŒæ™¯ï¼Œä¸CorrCLIPçš„ç»†ç²’åº¦åˆ†å‰²ç›®æ ‡ä¸å®Œå…¨åŒ¹é…
- ä½†åœ¨æ›´å…¨é¢çš„å¹³å‡æŒ‡æ ‡ä¸Šä»ä¿æŒæå‡

## 5. æ¶ˆèå®éªŒçš„æŒ‡æ ‡è®¾è®¡

### 5.1 ç»„ä»¶è´¡çŒ®åº¦é‡åŒ–

**Table 2çš„è®¾è®¡é€»è¾‘**ï¼š
```python
baseline = ClearCLIP()  # 49.3%
+ scope_reconstruction = 49.3% + 14.5% = 63.8%
+ value_reconstruction = 63.8% + 0.8% = 64.6%
+ map_correction = 64.6% + 1.3% = 65.9%
+ feature_refinement = 65.9% + 1.3% = 67.2%
```

**å¢é‡åˆ†æçš„æ„ä¹‰**ï¼š
- æ˜ç¡®å„ç»„ä»¶ç›¸å¯¹è´¡çŒ®
- æŒ‡å¯¼åç»­ä¼˜åŒ–æ–¹å‘
- éªŒè¯æ–¹æ³•è®¾è®¡çš„åˆç†æ€§

### 5.2 ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒ

**è™½ç„¶è®ºæ–‡æœªæ˜ç¡®æåŠï¼Œä½†éšå«çš„æ˜¾è‘—æ€§**ï¼š
- åœ¨å¤šæ•°æ®é›†ä¸Šä¸€è‡´æå‡
- ä¸åŒæ¨¡å‹è§„æ¨¡ä¸Šéƒ½æœ‰æ•ˆ
- æ¶ˆèå®éªŒä¸­å„ç»„ä»¶éƒ½æœ‰æ­£å‘è´¡çŒ®

## 6. ä¸å…¶ä»–è¯„ä»·æŒ‡æ ‡çš„å¯¹æ¯”

### 6.1 ä¸ºä»€ä¹ˆé€‰æ‹©mIoUè€Œéå…¶ä»–æŒ‡æ ‡ï¼Ÿ

**å¯¹æ¯”åˆ†æ**ï¼š

| æŒ‡æ ‡ | ä¼˜ç‚¹ | ç¼ºç‚¹ | é€‚ç”¨æ€§ |
|------|------|------|--------|
| **mIoU** | å¯¹ç±»åˆ«ä¸å¹³è¡¡ä¸æ•æ„Ÿï¼Œç›´è§‚ | å¿½ç•¥ç±»å†…å·®å¼‚ | **æœ¬æ–‡é€‰æ‹©** |
| Pixel Accuracy | è®¡ç®—ç®€å• | å¯¹å¤§ç±»åå‘ä¸¥é‡ | ä¸é€‚ç”¨ |
| FWIoU | è€ƒè™‘ç±»åˆ«é¢‘ç‡ | ä»å—å¤§ç±»å½±å“ | éƒ¨åˆ†å·¥ä½œä½¿ç”¨ |
| Diceç³»æ•° | åŒ»å­¦å›¾åƒå¸¸ç”¨ | å¯¹è¾¹ç•Œæ•æ„Ÿåº¦ä¸åŒ | ç‰¹å®šé¢†åŸŸ |

### 6.2 mIoUåœ¨å¼€æ”¾è¯æ±‡ä»»åŠ¡ä¸­çš„ä¼˜åŠ¿

**ç±»åˆ«ä¸å¯çŸ¥æ€§**ï¼š
```math
\text{mIoU} = \frac{1}{K}\sum IoU_i
```
- æ— è®ºKæ˜¯å¤šå°‘ï¼Œè®¡ç®—æ–¹å¼ä¸€è‡´
- é€‚åˆåŠ¨æ€ç±»åˆ«æ•°é‡çš„å¼€æ”¾è¯æ±‡è®¾ç½®
- ä¾¿äºè·¨æ•°æ®é›†æ¯”è¾ƒ

## 7. è¯„ä»·æŒ‡æ ‡çš„å±€é™æ€§

### 7.1 mIoUçš„å·²çŸ¥å±€é™

**ç©ºé—´ä¸€è‡´æ€§å¿½ç•¥**ï¼š
- mIoUä¸ç›´æ¥åº¦é‡åˆ†å‰²è¾¹ç•Œçš„å¹³æ»‘æ€§
- å¯èƒ½é«˜ä¼°"æ–‘ç‚¹çŠ¶"é¢„æµ‹çš„è´¨é‡
- è¿™æ­£æ˜¯å›¾æ ¡æ­£ç»„ä»¶è¦è§£å†³çš„é—®é¢˜

**ç±»åˆ«æƒé‡å¹³ç­‰**ï¼š
```python
# å¯¹å°ç±»åˆ«å’Œå¤§ç±»åˆ«åŒç­‰å¯¹å¾…
IoU_small_object = IoU_large_background
```
- åœ¨å®é™…åº”ç”¨ä¸­å¯èƒ½ä¸åˆç†
- ä½†ç¬¦åˆå­¦æœ¯æ¯”è¾ƒçš„å…¬å¹³æ€§åŸåˆ™

### 7.2 è®ºæ–‡ä¸­çš„è¡¥å……è¯„ä»·

**å®šæ€§åˆ†æ**ï¼š
- å¯è§†åŒ–ç»“æœå¯¹æ¯”ï¼ˆFigure 4ï¼‰
- è¾¹ç•Œè¿ç»­æ€§è§‚å¯Ÿ
- å™ªå£°æŠ‘åˆ¶æ•ˆæœ

**è®¡ç®—æ•ˆç‡**ï¼š
- æ¨ç†æ—¶é—´ï¼ˆTable 11ï¼‰
- å†…å­˜æ¶ˆè€—
- å‚æ•°æ•°é‡

## 8. æ€»ç»“

CorrCLIPçš„è¯„ä»·æŒ‡æ ‡è®¾è®¡ä½“ç°äº†ï¼š

1. **å…¨é¢æ€§**ï¼š8ä¸ªä¸åŒç‰¹ç‚¹çš„æ•°æ®é›†
2. **å…¬å¹³æ€§**ï¼šç»Ÿä¸€çš„è®­ç»ƒè‡ªç”±åè®®
3. **å¯é æ€§**ï¼šå¹¿æ³›æ¥å—çš„mIoUæŒ‡æ ‡
4. **æ·±å…¥æ€§**ï¼šç³»ç»Ÿçš„æ¶ˆèå®éªŒåˆ†æ
5. **å®ç”¨æ€§**ï¼šå…¼é¡¾æ€§èƒ½ä¸æ•ˆç‡

è¿™ç§ä¸¥è°¨çš„è¯„ä»·ä½“ç³»ä¸ºæ–¹æ³•çš„æœ‰æ•ˆæ€§æä¾›äº†æœ‰åŠ›è¯æ®ï¼Œä¹Ÿä¸ºæ­¤é¢†åŸŸåç»­ç ”ç©¶è®¾ç«‹äº†è¾ƒé«˜çš„æ¯”è¾ƒæ ‡å‡†ã€‚


# CorrCLIPä¸­çš„è‡ªç›‘ç£å®ç°æœºåˆ¶è¯¦è§£

## 1. è‡ªç›‘ç£åœ¨CorrCLIPä¸­çš„å…·ä½“ä½“ç°

### 1.1 æ ¸å¿ƒè§‚ç‚¹æ¾„æ¸…
**é‡è¦è¯´æ˜**ï¼šCorrCLIPæœ¬èº«æ˜¯**è®­ç»ƒè‡ªç”±(training-free)**æ–¹æ³•ï¼Œä½†å®ƒ**å·§å¦™åˆ©ç”¨**äº†å…¶ä»–æ¨¡å‹çš„è‡ªç›‘ç£é¢„è®­ç»ƒèƒ½åŠ›ï¼Œç‰¹åˆ«æ˜¯DINOæ¨¡å‹çš„è‡ªç›‘ç£ç‰¹å¾ã€‚

## 2. DINOè‡ªç›‘ç£ç‰¹å¾çš„åˆ©ç”¨

### 2.1 DINOçš„è‡ªç›‘ç£é¢„è®­ç»ƒåŸç†

**DINOè®­ç»ƒè¿‡ç¨‹**ï¼š
```python
# DINOçš„æ ¸å¿ƒè‡ªç›‘ç£æœºåˆ¶
student_network = ViT()
teacher_network = ViT()  # å‚æ•°æ¥è‡ªstudentçš„EMA

for image in dataset:
    # ç”Ÿæˆä¸¤ä¸ªéšæœºå¢å¼ºè§†å›¾
    view1 = random_augmentation(image)
    view2 = random_augmentation(image)
    
    # åˆ†åˆ«é€šè¿‡studentå’Œteacher
    output1 = student_network(view1)
    output2 = teacher_network(view2)
    
    # è‡ªç›‘ç£æŸå¤±ï¼šé¼“åŠ±ä¸¤ä¸ªè§†å›¾è¾“å‡ºä¸€è‡´
    loss = cross_entropy(output1, output2.softmax(dim=1))
```

**è‡ªç›‘ç£ç›®æ ‡**ï¼š
- è®©åŒä¸€å›¾åƒçš„ä¸åŒå¢å¼ºè§†å›¾äº§ç”Ÿç›¸ä¼¼çš„è¯­ä¹‰è¡¨ç¤º
- æ— éœ€äººå·¥æ ‡æ³¨ï¼Œä»æ•°æ®è‡ªèº«å­¦ä¹ è¯­ä¹‰ç»“æ„
- å­¦ä¹ åˆ°çš„ç‰¹å¾å…·æœ‰ä¼˜ç§€çš„è¯­ä¹‰å¸ƒå±€ç†è§£èƒ½åŠ›

### 2.2 CorrCLIPå¦‚ä½•åˆ©ç”¨DINOçš„è‡ªç›‘ç£ç‰¹å¾

#### 2.2.1 å€¼é‡å»ºä¸­çš„DINOç‰¹å¾åº”ç”¨

**å…¬å¼å®ç°**ï¼š
```math
F_S = Q_D + K_D
S = \frac{F_S F_S^{\mathrm{T}}}{\|F_S\|^2}
```

**å…·ä½“æµç¨‹**ï¼š
```python
# 1. ä½¿ç”¨é¢„è®­ç»ƒå¥½çš„DINOæ¨¡å‹ï¼ˆè‡ªç›‘ç£è®­ç»ƒæ‰€å¾—ï¼‰
dino_model = load_pretrained_dino()  # å·²ç»é€šè¿‡è‡ªç›‘ç£å­¦ä¹ 

# 2. æå–DINOç‰¹å¾
with torch.no_grad():
    dino_features = dino_model(image)  # è·å¾—Q_D, K_D, V_D
    
# 3. æ„å»ºè¯­ä¹‰ä¸€è‡´çš„ç›¸ä¼¼æ€§çŸ©é˜µ
F_S = dino_features['query'] + dino_features['key']
similarity_matrix = (F_S @ F_S.T) / torch.norm(F_S, dim=1, keepdim=True)
```

#### 2.2.2 ä¸ºä»€ä¹ˆDINOç‰¹å¾æ›´"è¯­ä¹‰ä¸€è‡´"ï¼Ÿ

**è‡ªç›‘ç£å­¦ä¹ çš„ä¼˜åŠ¿**ï¼š
- **å¯¹è±¡å®Œæ•´æ€§**ï¼šDINOé€šè¿‡è‡ªç›‘ç£å­¦ä¹ åˆ°ç‰©ä½“çš„å®Œæ•´è¯­ä¹‰è¾¹ç•Œ
- **å¸ƒå±€ç†è§£**ï¼šèƒ½å¤Ÿç†è§£å›¾åƒçš„è¯­ä¹‰å¸ƒå±€ç»“æ„
- **ä¸€è‡´æ€§**ï¼šåŒä¸€ç‰©ä½“çš„ä¸åŒéƒ¨åˆ†å…·æœ‰ç›¸ä¼¼çš„ç‰¹å¾è¡¨ç¤º

**ä¸CLIPå¯¹æ¯”**ï¼š
```python
# CLIPç‰¹å¾ï¼ˆå¯¹æ¯”å­¦ä¹ è®­ç»ƒï¼‰
clip_similarity = compute_clip_similarity()  # å¯èƒ½äº§ç”Ÿè·¨å¯¹è±¡çš„é«˜ç›¸ä¼¼åº¦

# DINOç‰¹å¾ï¼ˆè‡ªç›‘ç£è®­ç»ƒï¼‰  
dino_similarity = compute_dino_similarity()  # æ›´ç¬¦åˆè¯­ä¹‰è¾¹ç•Œ
```

## 3. è‡ªç›‘ç£åœ¨èŒƒå›´é‡å»ºä¸­çš„åº”ç”¨

### 3.1 SAMçš„è‡ªç›‘ç£ç‰¹æ€§

**SAMçš„è®­ç»ƒç‰¹ç‚¹**ï¼š
- è™½ç„¶SAMä½¿ç”¨ç›‘ç£æ•°æ®ï¼Œä½†å…¶**æç¤ºå·¥ç¨‹**å¯è§†ä¸ºä¸€ç§è‡ªç›‘ç£å½¢å¼
- èƒ½å¤Ÿä»ä»»æ„ç‚¹/æ¡†ç”Ÿæˆåˆ†å‰²æ©ç ï¼Œä¸ä¾èµ–ç‰¹å®šç±»åˆ«
- ä½“ç°äº†**ç±»åˆ«æ— å…³**çš„åˆ†å‰²èƒ½åŠ›

### 3.2 æ©ç ç”Ÿæˆçš„è‡ªç›‘ç£æ€§è´¨

**å®ç°è¿‡ç¨‹**ï¼š
```python
# è‡ªç›‘ç£çš„æ©ç ç”Ÿæˆç­–ç•¥
def generate_self_supervised_masks(image):
    # 1. å‡åŒ€é‡‡æ ·ç‚¹ï¼ˆä¸ä¾èµ–ç±»åˆ«ä¿¡æ¯ï¼‰
    points = uniform_sampling(image, grid_32x32)
    
    # 2. ä¸ºæ¯ä¸ªç‚¹ç”Ÿæˆåˆ†å‰²æ©ç 
    masks = []
    for point in points:
        mask = sam_model.predict(point, image)
        masks.append(mask)
    
    # 3. åŸºäºç‰¹å¾ç›¸ä¼¼æ€§åˆå¹¶æ©ç ï¼ˆè‡ªç›‘ç£èšç±»ï¼‰
    merged_masks = self_supervised_clustering(masks)
    return merged_masks
```

## 4. è‡ªç›‘ç£ç›¸ä¼¼æ€§è®¡ç®—çš„å…·ä½“å®ç°

### 4.1 ç‰¹å¾ç›¸ä¼¼æ€§çš„è‡ªç›‘ç£åº¦é‡

**Table 5ä¸­çš„ä¸åŒç›¸ä¼¼æ€§è®¡ç®—æ–¹å¼**ï¼š

| ç›¸ä¼¼æ€§ç±»å‹ | ç‰¹å¾æ¥æº | è‡ªç›‘ç£ç¨‹åº¦ | æ€§èƒ½ |
|-----------|----------|------------|------|
| Uniform | æ—  | æ—  | 73.4 |
| Q-K | CLIP-B | å¼± | 69.5 |
| Q-Q | CLIP-B | å¼± | 73.8 |
| X-X | DINO-B | **å¼ºè‡ªç›‘ç£** | 73.4 |
| QK-QK | DINO-S | **å¼ºè‡ªç›‘ç£** | 74.3 |
| QK-QK | DINO-B | **å¼ºè‡ªç›‘ç£** | 74.2 |

### 4.2 è‡ªç›‘ç£ç‰¹å¾çš„ä¼˜åŠ¿è¯æ˜

**ä»Table 5åˆ†æ**ï¼š
```python
# æ€§èƒ½å¯¹æ¯”åˆ†æ
clip_based_methods = [69.5, 73.8]  # ä½¿ç”¨CLIPç‰¹å¾
dino_based_methods = [73.4, 74.3, 74.2]  # ä½¿ç”¨DINOè‡ªç›‘ç£ç‰¹å¾

average_clip = np.mean(clip_based_methods)   # 71.65
average_dino = np.mean(dino_based_methods)   # 73.97
```

**ç»“è®º**ï¼šè‡ªç›‘ç£çš„DINOç‰¹å¾ç›¸æ¯”CLIPç‰¹å¾æä¾›çº¦2.3%çš„æ€§èƒ½æå‡ã€‚

## 5. æ©ç åˆå¹¶çš„è‡ªç›‘ç£èšç±»

### 5.1 DBSCANçš„æ— ç›‘ç£èšç±»

**å®ç°ç»†èŠ‚**ï¼š
```python
def self_supervised_mask_merging(masks, region_features):
    # ä½¿ç”¨DBSCANè¿›è¡Œæ— ç›‘ç£èšç±»
    from sklearn.cluster import DBSCAN
    
    # å‚æ•°è®¾ç½®ï¼ˆè‡ªç›‘ç£æ€§è´¨ï¼‰
    clustering = DBSCAN(
        eps=0.2,           # é‚»åŸŸåŠå¾„
        min_samples=1,     # æœ€å°æ ·æœ¬æ•°
        metric='cosine'    # ä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦
    )
    
    # åŸºäºåŒºåŸŸç‰¹å¾è¿›è¡Œèšç±»
    labels = clustering.fit_predict(region_features)
    
    # åˆå¹¶ç›¸åŒç°‡çš„æ©ç 
    merged_masks = merge_masks_by_cluster(masks, labels)
    return merged_masks
```

### 5.2 è‡ªç›‘ç£èšç±»çš„ä¼˜åŠ¿

**æ— éœ€ç±»åˆ«æ ‡æ³¨**ï¼š
- åŸºäºç‰¹å¾ç›¸ä¼¼æ€§è‡ªåŠ¨å‘ç°è¯­ä¹‰ç›¸å…³çš„åŒºåŸŸ
- é€‚åº”ä»»æ„å›¾åƒå†…å®¹
- ç¬¦åˆå¼€æ”¾è¯æ±‡çš„è®¾ç½®

## 6. è‡ªç›‘ç£åœ¨æ•´ä¸ªæµç¨‹ä¸­çš„ä½œç”¨

### 6.1 ç«¯åˆ°ç«¯çš„è‡ªç›‘ç£é›†æˆ

```python
class CorrCLIP:
    def forward(self, image, class_names):
        # 1. è‡ªç›‘ç£æ©ç ç”Ÿæˆï¼ˆSAMï¼‰
        masks = self.self_supervised_mask_generation(image)
        
        # 2. è‡ªç›‘ç£ç‰¹å¾æå–ï¼ˆDINOï¼‰
        dino_features = self.self_supervised_feature_extraction(image)
        
        # 3. è‡ªç›‘ç£ç›¸ä¼¼æ€§è®¡ç®—
        similarity = self.self_supervised_similarity(dino_features)
        
        # 4. è‡ªç›‘ç£æ©ç åˆå¹¶
        merged_masks = self.self_supervised_clustering(masks)
        
        # 5. åº”ç”¨è‡ªç›‘ç£æ”¹è¿›çš„ç›¸å…³æ€§
        output = self.apply_self_supervised_correlations(
            similarity, merged_masks, class_names
        )
        return output
```

### 6.2 è‡ªç›‘ç£ç»„ä»¶çš„ååŒæ•ˆåº”

**äº’è¡¥ä¼˜åŠ¿**ï¼š
- **DINO**ï¼šæä¾›è¯­ä¹‰ä¸€è‡´çš„ç‰¹å¾è¡¨ç¤º
- **SAM**ï¼šæä¾›å‡†ç¡®çš„å¯¹è±¡è¾¹ç•Œ
- **DBSCAN**ï¼šæä¾›æ— ç›‘ç£çš„è¯­ä¹‰åˆ†ç»„

## 7. ä¸ä¼ ç»Ÿè‡ªç›‘ç£å­¦ä¹ çš„åŒºåˆ«

### 7.1 å…³é”®å·®å¼‚

| æ–¹é¢ | ä¼ ç»Ÿè‡ªç›‘ç£ | CorrCLIPçš„è‡ªç›‘ç£åˆ©ç”¨ |
|------|------------|---------------------|
| è®­ç»ƒè¿‡ç¨‹ | éœ€è¦è‡ªç›‘ç£é¢„è®­ç»ƒ | ç›´æ¥ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹ |
| ç›®æ ‡ | å­¦ä¹ é€šç”¨ç‰¹å¾è¡¨ç¤º | æ”¹è¿›ç‰¹å®šä»»åŠ¡æ€§èƒ½ |
| æ•°æ®ä¾èµ– | éœ€è¦å¤§é‡æ— æ ‡æ³¨æ•°æ® | é›¶æ ·æœ¬ï¼Œæ— éœ€é¢å¤–æ•°æ® |
| è®¡ç®—æˆæœ¬ | é«˜ï¼ˆè®­ç»ƒè¿‡ç¨‹ï¼‰ | ä½ï¼ˆä»…æ¨ç†ï¼‰ |

### 7.2 CorrCLIPçš„åˆ›æ–°ä¹‹å¤„

**"å³æ’å³ç”¨"çš„è‡ªç›‘ç£**ï¼š
```python
# ä¸éœ€è¦é‡æ–°è®­ç»ƒè‡ªç›‘ç£æ¨¡å‹
# ç›´æ¥åˆ©ç”¨ç°æœ‰è‡ªç›‘ç£æ¨¡å‹çš„èƒ½åŠ›
self.dino = load_pretrained_dino()  # è‡ªç›‘ç£é¢„è®­ç»ƒå®Œæˆ
self.sam = load_pretrained_sam()    # æç¤ºå·¥ç¨‹è®­ç»ƒå®Œæˆ

# åœ¨æ¨ç†æ—¶ç»„åˆè¿™äº›èƒ½åŠ›
result = combine_self_supervised_models(image)
```

## 8. å®éªŒéªŒè¯çš„è‡ªç›‘ç£æ•ˆæœ

### 8.1 æ¶ˆèå®éªŒè¯æ˜

**ä»Table 5çœ‹å‡º**ï¼š
- çº¯è‡ªç›‘ç£æ–¹æ³•ï¼ˆDINO-onlyï¼‰è¾¾åˆ°73.4 mIoU
- æ··åˆæ–¹æ³•ï¼ˆDINO+CLIPï¼‰è¾¾åˆ°æœ€ä½³74.2 mIoU
- è¯æ˜è‡ªç›‘ç£ç‰¹å¾çš„æœ‰æ•ˆæ€§

### 8.2 è‡ªç›‘ç£çš„æ³›åŒ–èƒ½åŠ›

**Table 9ä¸­çš„è·¨åŸŸè¯„ä¼°**ï¼š
```python
# åœ¨åˆ†å¸ƒå¤–æ•°æ®é›†ä¸Šçš„è¡¨ç°
out_of_distribution_datasets = ['FoodSeg103', 'ATLANTIS', 'CUB-200', 'SUIM']
corrclip_performance = [36.5, 40.1, 31.3, 58.0]
supervised_methods = [30.5, 33.6, 9.2, 54.0]  # å…¨ç›‘ç£æ–¹æ³•
```

**ç»“è®º**ï¼šè‡ªç›‘ç£ç‰¹å¾çš„åˆ©ç”¨ä½¿CorrCLIPåœ¨æœªçŸ¥é¢†åŸŸè¡¨ç°æ›´å¥½ã€‚

## 9. æ€»ç»“

CorrCLIPé€šè¿‡ä»¥ä¸‹æ–¹å¼å®ç°è‡ªç›‘ç£ï¼š

1. **ç‰¹å¾çº§è‡ªç›‘ç£**ï¼šåˆ©ç”¨DINOçš„è‡ªç›‘ç£é¢„è®­ç»ƒç‰¹å¾
2. **åˆ†å‰²çº§è‡ªç›‘ç£**ï¼šåˆ©ç”¨SAMçš„æç¤ºå·¥ç¨‹åˆ†å‰²èƒ½åŠ›  
3. **èšç±»çº§è‡ªç›‘ç£**ï¼šä½¿ç”¨æ— ç›‘ç£èšç±»åˆå¹¶è¯­ä¹‰åŒºåŸŸ
4. **ååŒè‡ªç›‘ç£**ï¼šå¤šæ¨¡å‹è‡ªç›‘ç£èƒ½åŠ›çš„ç»„åˆåˆ©ç”¨

è¿™ç§"å³æ’å³ç”¨"çš„è‡ªç›‘ç£ç­–ç•¥ï¼š
- æ— éœ€é¢å¤–è®­ç»ƒæˆæœ¬
- å……åˆ†åˆ©ç”¨ç°æœ‰è‡ªç›‘ç£æ¨¡å‹çš„å¼ºå¤§èƒ½åŠ›
- åœ¨ä¿æŒè®­ç»ƒè‡ªç”±åº¦çš„åŒæ—¶æ˜¾è‘—æå‡æ€§èƒ½
- ä½“ç°äº†ç°ä»£åŸºç¡€æ¨¡å‹ç»„åˆä½¿ç”¨çš„åˆ›æ–°æ€è·¯


# ğŸ¯ æ·±å…¥ç†è§£CorrCLIPï¼šé‡æ–°æ„å»ºCLIPä¸­çš„è¡¥ä¸ç›¸å…³æ€§

## ğŸ“– è®ºæ–‡æ ¸å¿ƒæ€æƒ³é€šä¿—è§£è¯»

### ğŸ¤” ä»€ä¹ˆæ˜¯å¼€æ”¾è¯æ±‡è¯­ä¹‰åˆ†å‰²ï¼Ÿ
æƒ³è±¡ä¸€ä¸‹ï¼Œä½ çœ‹åˆ°ä¸€ä¸ªå›¾ç‰‡ï¼Œéœ€è¦æŠŠå›¾ç‰‡ä¸­çš„æ¯ä¸ªåƒç´ éƒ½æ ‡ä¸Šæ ‡ç­¾ï¼ˆæ¯”å¦‚"äºº"ã€"æ ‘"ã€"å¤©ç©º"ï¼‰ï¼Œä½†ä¸åƒä¼ ç»Ÿæ–¹æ³•é‚£æ ·åªèƒ½è¯†åˆ«é¢„å…ˆå®šä¹‰å¥½çš„å‡ ç±»ï¼Œè€Œæ˜¯å¯ä»¥è¯†åˆ«ä»»ä½•ç”¨æ–‡å­—æè¿°çš„ç±»åˆ«ã€‚è¿™å°±æ˜¯**å¼€æ”¾è¯æ±‡è¯­ä¹‰åˆ†å‰²**ã€‚

### ğŸ¯ CLIPçš„å›°å¢ƒ
CLIPæ˜¯ä¸ªå¾ˆå‰å®³çš„AIæ¨¡å‹ï¼Œå®ƒèƒ½çœ‹æ‡‚å›¾ç‰‡å’Œæ–‡å­—çš„å…³ç³»ï¼Œæ¯”å¦‚ç»™ä½ ä¸€å¼ çŒ«çš„å›¾ç‰‡å’Œ"çŒ«"è¿™ä¸ªæ–‡å­—ï¼Œå®ƒèƒ½åˆ¤æ–­æ˜¯å¦åŒ¹é…ã€‚ä½†å½“æˆ‘ä»¬æƒ³ç”¨å®ƒæ¥åšåƒç´ çº§çš„åˆ†å‰²æ—¶ï¼Œå°±é‡åˆ°äº†é—®é¢˜ï¼š

**æ ¸å¿ƒé—®é¢˜**ï¼šCLIPåœ¨åˆ¤æ–­å›¾ç‰‡æ•´ä½“å†…å®¹æ—¶å¾ˆå‡†ï¼Œä½†åœ¨åˆ¤æ–­æ¯ä¸ªå°åŒºåŸŸï¼ˆpatchï¼‰æ—¶å°±ä¸å¤Ÿç²¾ç¡®äº†ã€‚å°±åƒä¸€ä¸ªäººèƒ½ä»è¿œå¤„è®¤å‡ºæ˜¯åªçŒ«ï¼Œä½†çœ‹ä¸æ¸…çŒ«èº«ä¸Šçš„å…·ä½“ç»†èŠ‚ã€‚

**æ ¹æœ¬åŸå› **ï¼šè®ºæ–‡å‘ç°ï¼Œé—®é¢˜å‡ºåœ¨**ä¸åŒç±»åˆ«åŒºåŸŸä¹‹é—´çš„ç›¸äº’å¹²æ‰°**ï¼ˆinter-class correlationsï¼‰ã€‚æ¯”å¦‚åœ¨åˆ¤æ–­"çŒ«è€³æœµ"è¿™ä¸ªåŒºåŸŸæ—¶ï¼ŒCLIPä¼šä¸å¿…è¦åœ°å‚è€ƒ"èƒŒæ™¯æ²™å‘"çš„ä¿¡æ¯ï¼Œå¯¼è‡´åˆ¤æ–­ä¸å‡†ã€‚

## ğŸ› ï¸ CorrCLIPçš„å››å¤§åˆ›æ–°è§£æ³•

### 1. ğŸ” èŒƒå›´é‡å»ºï¼šåˆ’å®š"äº¤æµèŒƒå›´"
**é€šä¿—ç†è§£**ï¼šå°±åƒåœ¨æ•™å®¤é‡Œï¼Œæˆ‘ä»¬åªè®©åŒä¸€å°ç»„çš„åŒå­¦äº’ç›¸è®¨è®ºï¼Œä¸è®©è·¨ç»„ä¹±èŠã€‚

**æŠ€æœ¯å®ç°**ï¼š
- ä½¿ç”¨SAMæ¨¡å‹å…ˆæŠŠå›¾ç‰‡åˆ†æˆå¤šä¸ªåŒºåŸŸ
- åªå…è®¸åŒä¸€ä¸ªåŒºåŸŸå†…çš„patchç›¸äº’"äº¤æµ"
- ç”¨æ•°å­¦å…¬å¼è¡¨ç¤ºï¼š
  ```math
  äº¤äº’çŸ©é˜µE = âˆ‘(æ¯ä¸ªåŒºåŸŸæ©ç çš„å¤–ç§¯) + (æœªåˆ†å‰²åŒºåŸŸçš„é˜ˆå€¼è¿‡æ»¤)
  ```

**æ”¹è¿›å»ºè®®**ï¼š
- å¯ä»¥ä½¿ç”¨æ›´è½»é‡çš„åˆ†å‰²æ¨¡å‹å¦‚MobileSAMæ›¿ä»£åŸå§‹SAMï¼Œæå‡é€Ÿåº¦
- å¼•å…¥åŠ¨æ€åŒºåŸŸåˆå¹¶ç­–ç•¥ï¼Œæ ¹æ®è¯­ä¹‰ç›¸ä¼¼åº¦è‡ªé€‚åº”è°ƒæ•´åŒºåŸŸå¤§å°

### 2. ğŸ“Š å€¼é‡å»ºï¼šä¼˜åŒ–"äº¤æµè´¨é‡"
**é€šä¿—ç†è§£**ï¼šå³ä½¿åœ¨åŒä¸€åŒºåŸŸå†…ï¼Œä¹Ÿè¦ç¡®ä¿å¤§å®¶ç”¨åŒä¸€ç§"è¯­è¨€"äº¤æµï¼Œé¿å…é¸¡åŒé¸­è®²ã€‚

**æŠ€æœ¯å®ç°**ï¼š
- ç”¨DINOæ¨¡å‹ï¼ˆæ¯”CLIPæ›´æ‡‚å›¾åƒç»“æ„ï¼‰é‡æ–°è®¡ç®—patchä¹‹é—´çš„ç›¸ä¼¼åº¦
- æ–°çš„ç›¸ä¼¼åº¦è®¡ç®—ï¼š
  ```math
  S = (Q_D + K_D)(Q_D + K_D)^T / ||Q_D + K_D||^2
  ```

**æ”¹è¿›å»ºè®®**ï¼š
- å¯ä»¥å°è¯•ç»“åˆå¤šä¸ªè‡ªç›‘ç£æ¨¡å‹ï¼ˆå¦‚DINOv2ã€MAEï¼‰çš„ç‰¹å¾ï¼Œè·å¾—æ›´é²æ£’çš„ç›¸ä¼¼åº¦è®¡ç®—
- å¼•å…¥å¯å­¦ä¹ çš„æ¸©åº¦ç³»æ•°Ï„ï¼Œè€Œä¸æ˜¯å›ºå®šå€¼0.25

### 3. ğŸ¨ ç‰¹å¾ç²¾ç‚¼ï¼šå¢å¼º"è¡¨è¾¾èƒ½åŠ›"
**é€šä¿—ç†è§£**ï¼šç»™æ¯ä¸ªåŒºåŸŸé…ä¸€ä¸ª"ä»£è¨€äºº"ï¼ŒåŒæ—¶ä¿ç•™æ›´å¤šçš„ç»†èŠ‚ä¿¡æ¯ã€‚

**æŠ€æœ¯å®ç°**ï¼š
- **è¯­ä¹‰åˆ†æ”¯**ï¼šä¸ºæ¯ä¸ªåŒºåŸŸåˆ›å»ºä¸“é—¨çš„ç±»åˆ«æ ‡è®°ï¼Œèšåˆå…¨å±€ä¿¡æ¯
- **ç©ºé—´åˆ†æ”¯**ï¼šèåˆæµ…å±‚ç‰¹å¾ï¼Œä¿ç•™æ›´å¤šç©ºé—´ç»†èŠ‚
- æœ€ç»ˆç‰¹å¾ = ä¸»åˆ†æ”¯ç‰¹å¾ + Î±Ã—ç©ºé—´ç‰¹å¾ + Î²Ã—è¯­ä¹‰ç‰¹å¾

**æ”¹è¿›å»ºè®®**ï¼š
- å¯ä»¥ä½¿ç”¨æ³¨æ„åŠ›æœºåˆ¶è‡ªé€‚åº”é€‰æ‹©æœ€ç›¸å…³çš„æµ…å±‚ç‰¹å¾ï¼Œè€Œä¸æ˜¯ç®€å•ç›¸åŠ 
- å¼•å…¥è·¨æ¨¡æ€äº¤äº’ï¼Œè®©å›¾åƒç‰¹å¾å’Œæ–‡æœ¬ç‰¹å¾åœ¨æ—©æœŸå°±è¿›è¡Œäº¤äº’

### 4. ğŸ—ºï¸ åœ°å›¾æ ¡æ­£ï¼šç¡®ä¿"æ•´é½åˆ’ä¸€"
**é€šä¿—ç†è§£**ï¼šå¦‚æœä¸€ä¸ªåŒºåŸŸå†…å¤§å¤šæ•°patchéƒ½è®¤ä¸ºæ˜¯"çŒ«"ï¼Œå°±æŠŠå°‘æ•°è®¤ä¸ºæ˜¯"ç‹—"çš„ä¹Ÿæ”¹æˆ"çŒ«"ï¼Œä¿æŒä¸€è‡´æ€§ã€‚

**æŠ€æœ¯å®ç°**ï¼š
```
æ¯ä¸ªåŒºåŸŸå†…çš„é¢„æµ‹æ ‡ç­¾ = è¯¥åŒºåŸŸå†…æœ€é¢‘ç¹å‡ºç°çš„ç±»åˆ«
```

## ğŸ“ˆ å®éªŒç»“æœæ·±åº¦åˆ†æ

### ğŸ† æ€§èƒ½è¡¨ç°
| æ¨¡å‹å˜ä½“ | å¹³å‡mIoU | æå‡å¹…åº¦ |
|---------|----------|----------|
| åŸå§‹CLIP | 10.1% | - |
| ç°æœ‰æœ€ä½³æ–¹æ³• | 48.6% | - |
| CorrCLIP | 53.6% | +5.0% |

**å…³é”®è§‚å¯Ÿ**ï¼šåœ¨8ä¸ªæµ‹è¯•æ•°æ®é›†ä¸Šå…¨éƒ¨å–å¾—æœ€ä¼˜æ•ˆæœï¼Œç‰¹åˆ«æ˜¯åœ¨å¤æ‚åœºæ™¯ï¼ˆå¦‚Cityscapesï¼‰æå‡æœ€æ˜æ˜¾ã€‚

### ğŸ”¬ æ¶ˆèå®éªŒæ´å¯Ÿ
- **èŒƒå›´é‡å»º**è´¡çŒ®æœ€å¤§ï¼ˆ+14.5% mIoUï¼‰
- **å€¼é‡å»º**è¿›ä¸€æ­¥ä¼˜åŒ–ï¼ˆ+2-3% mIoUï¼‰
- ä¸¤ä¸ªé™„åŠ åˆ†æ”¯æœ‰ååŒæ•ˆåº”ï¼Œç»„åˆä½¿ç”¨æ•ˆæœæœ€å¥½

## ğŸ’¡ åŸºäºå½“å‰æŠ€æœ¯çš„æ”¹è¿›æ–¹æ¡ˆ

### ğŸš€ æ•ˆç‡ä¼˜åŒ–æ–¹æ¡ˆ
```python
# ä¼ªä»£ç ï¼šè½»é‡çº§CorrCLIPå®ç°
class LiteCorrCLIP:
    def __init__(self):
        self.clip = CLIPModel()
        self.sam = MobileSAM()  # è½»é‡SAM
        self.dino = DINOv2_small()  # å°å°ºå¯¸DINO
        
    def segment(self, image, class_names):
        # 1. è‡ªé€‚åº”é‡‡æ ·ç‚¹ï¼Œå‡å°‘è®¡ç®—é‡
        masks = self.sam.generate_masks(image, points=64)  # å‡å°‘é‡‡æ ·ç‚¹
        
        # 2. åŠ¨æ€åŒºåŸŸåˆå¹¶
        merged_masks = self.adaptive_cluster(masks)
        
        # 3. å¤šå°ºåº¦ç‰¹å¾èåˆ
        features = self.multi_scale_fusion(image)
        
        return segmentation_map
```

### ğŸ§  ç®—æ³•å±‚é¢æ”¹è¿›

#### 1. æ™ºèƒ½åŒºåŸŸåˆ’åˆ†
```python
# åŸºäºè¯­ä¹‰é‡è¦æ€§çš„åŒºåŸŸåˆ’åˆ†
def semantic_aware_partition(masks, semantic_importance):
    """æ ¹æ®è¯­ä¹‰é‡è¦æ€§åŠ¨æ€è°ƒæ•´åŒºåŸŸç²’åº¦"""
    important_regions = refine_detailed(masks[semantic_importance > threshold])
    other_regions = merge_coarse(masks[semantic_importance <= threshold])
    return important_regions + other_regions
```

#### 2. æ¸è¿›å¼ç›¸å…³æ€§é‡å»º
```python
def progressive_correlation_reconstruction():
    """åˆ†é˜¶æ®µæ„å»ºç›¸å…³æ€§"""
    # é˜¶æ®µ1ï¼šç²—ç²’åº¦åŒºåŸŸåˆ’åˆ†
    coarse_masks = get_coarse_segmentation()
    
    # é˜¶æ®µ2ï¼šåœ¨é‡è¦åŒºåŸŸè¿›è¡Œç»†ç²’åº¦åˆ’åˆ†
    important_areas = identify_important_regions()
    refined_masks = refine_important_areas(important_areas)
    
    # é˜¶æ®µ3ï¼šå¤šå°ºåº¦ç›¸å…³æ€§èåˆ
    return fuse_multi_scale_correlations()
```

#### 3. è·¨æ¨¡æ€æ—©æœŸèåˆ
```python
def early_cross_modal_fusion(image_features, text_features):
    """åœ¨ç‰¹å¾æå–æ—©æœŸå°±è¿›è¡Œå›¾æ–‡äº¤äº’"""
    # æ–‡æœ¬æŒ‡å¯¼çš„å›¾åƒç‰¹å¾å¢å¼º
    text_guided_features = cross_attention(image_features, text_features)
    
    # å›¾åƒæ„ŸçŸ¥çš„æ–‡æœ¬ç‰¹å¾ç»†åŒ–
    image_aware_text = cross_attention(text_features, image_features)
    
    return text_guided_features, image_aware_text
```

## ğŸ”® æœªæ¥å‘å±•æ–¹å‘

### 1. ğŸ¯ å®æ—¶åº”ç”¨ä¼˜åŒ–
- å¼€å‘ç§»åŠ¨ç«¯å‹å¥½çš„è½»é‡ç‰ˆæœ¬
- æ”¯æŒè§†é¢‘æµå®æ—¶åˆ†å‰²
- è¾¹ç¼˜è®¾å¤‡éƒ¨ç½²ä¼˜åŒ–

### 2. ğŸ¤– å¤šæ¨¡æ€æ‰©å±•
- ç»“åˆè¯­éŸ³æŒ‡ä»¤è¿›è¡Œåˆ†å‰²
- æ”¯æŒå¤æ‚æ–‡æœ¬æè¿°çš„åˆ†å‰²ä»»åŠ¡
- å¤šè¯­è¨€å¼€æ”¾è¯æ±‡åˆ†å‰²

### 3. ğŸ§© è‡ªé€‚åº”å­¦ä¹ 
- åœ¨çº¿å­¦ä¹ é€‚åº”æ–°ç±»åˆ«
- å°‘æ ·æœ¬å­¦ä¹ èƒ½åŠ›
- é¢†åŸŸè‡ªé€‚åº”è¿ç§»

## ğŸ’ æ ¸å¿ƒä»·å€¼æ€»ç»“

CorrCLIPçš„æ ¸å¿ƒçªç ´åœ¨äº**ç³»ç»Ÿæ€§åœ°è§£å†³äº†CLIPåœ¨å¯†é›†é¢„æµ‹ä»»åŠ¡ä¸­çš„ç»“æ„æ€§é—®é¢˜**ï¼š

1. **è¯Šæ–­å‡†ç¡®**ï¼šå‡†ç¡®è¯†åˆ«å‡ºè·¨ç±»åˆ«ç›¸å…³æ€§æ˜¯æ€§èƒ½ç“¶é¢ˆ
2. **è§£æ³•ç³»ç»Ÿ**ï¼šä»èŒƒå›´ã€æ•°å€¼ã€ç‰¹å¾ã€ç»“æœå››ä¸ªå±‚é¢å…¨é¢ä¼˜åŒ–
3. **æ•ˆæœæ˜¾è‘—**ï¼šåœ¨å¤šä¸ªåŸºå‡†ä¸Šå®ç°æ˜¾è‘—æå‡
4. **æ— éœ€è®­ç»ƒ**ï¼šä¿æŒCLIPçš„é›¶æ ·æœ¬èƒ½åŠ›ï¼Œç›´æ¥åº”ç”¨

è¿™ç§æ–¹æ³•è®ºä¸ä»…é€‚ç”¨äºè¯­ä¹‰åˆ†å‰²ï¼Œå¯¹ç›®æ ‡æ£€æµ‹ã€å®ä¾‹åˆ†å‰²ç­‰å¯†é›†é¢„æµ‹ä»»åŠ¡éƒ½æœ‰é‡è¦å¯å‘æ„ä¹‰ã€‚

---


# ğŸ§  CorrCLIPç®—æ³•åŸç†ä¸å…¬å¼è¶…è¯¦è§£

## ğŸ¯ æ•´ä½“æ¡†æ¶æ¦‚è¿°

CorrCLIPçš„æ ¸å¿ƒæ€æƒ³æ˜¯é€šè¿‡**é‡å»ºpatchç›¸å…³æ€§**æ¥æå‡CLIPåœ¨å¼€æ”¾è¯æ±‡è¯­ä¹‰åˆ†å‰²ä¸­çš„è¡¨ç°ã€‚æ•´ä½“æµç¨‹å¦‚ä¸‹ï¼š

```
è¾“å…¥å›¾åƒ â†’ CLIPè§†è§‰ç¼–ç å™¨ â†’ Patchç‰¹å¾ â†’ ç›¸å…³æ€§é‡å»º â†’ ç‰¹å¾ç²¾ç‚¼ â†’ åˆ†å‰²é¢„æµ‹ â†’ åœ°å›¾æ ¡æ­£ â†’ è¾“å‡ºåˆ†å‰²å›¾
              â†‘              â†‘           â†‘
          æ–‡æœ¬ç¼–ç å™¨      SAMæ©ç       DINOç‰¹å¾
```

## 1. ğŸ” åŸºç¡€é¢„å¤‡çŸ¥è¯†

### 1.1 CLIPè§†è§‰ç¼–ç å™¨æµç¨‹

å¯¹äºè¾“å…¥å›¾åƒï¼Œé¦–å…ˆé€šè¿‡Vision Transformerå¤„ç†ï¼š

1. **å›¾åƒåˆ†å—**ï¼šå›¾åƒåˆ’åˆ†ä¸º$N$ä¸ªpatch
2. **çº¿æ€§æŠ•å½±**ï¼š$X_C = \text{Linear}(\text{Patches}) \in \mathbb{R}^{N \times d}$
3. **ä½ç½®ç¼–ç **ï¼š$X_C = X_C + \text{PosEnc}$
4. **Transformerå±‚**ï¼šå‰L-1å±‚æ ‡å‡†å¤„ç†ï¼Œæœ€åä¸€å±‚ç‰¹æ®Šå¤„ç†

### 1.2 æ ‡å‡†è‡ªæ³¨æ„åŠ›æœºåˆ¶

```python
# æ ‡å‡†å¤šå¤´è‡ªæ³¨æ„åŠ›
class MultiHeadAttention(nn.Module):
    def forward(self, X):
        Q = W_q * X  # [N, d]
        K = W_k * X  # [N, d] 
        V = W_v * X  # [N, d]
        
        # ç›¸ä¼¼åº¦è®¡ç®—
        S = Q @ K.T / sqrt(d)  # [N, N]
        
        # æ³¨æ„åŠ›æƒé‡
        A = softmax(S)  # [N, N]
        
        # ç‰¹å¾èšåˆ
        Output = A @ V  # [N, d]
        return Output
```

## 2. ğŸ¯ èŒƒå›´é‡å»ºè¯¦ç»†æ¨å¯¼

### 2.1 SAMæ©ç ç”Ÿæˆ

è®¾è¾“å…¥å›¾åƒ$I \in \mathbb{R}^{H \times W \times 3}$ï¼ŒSAMç”ŸæˆZä¸ªåŒºåŸŸæ©ç ï¼š

$$
M = \{m_1, m_2, ..., m_Z\} \in \mathbb{R}^{Z \times H \times W}
$$

**ä¸‹é‡‡æ ·åˆ°patchçº§åˆ«**ï¼š
```math
$$
m_i^{patch} = \text{Downsample}(m_i) \in \mathbb{R}^{N}
$$
```
å…¶ä¸­$N = \frac{H}{P} \times \frac{W}{P}$ï¼ŒPä¸ºpatchå¤§å°ã€‚

### 2.2 æ©ç åˆå¹¶ç®—æ³•

**åŒºåŸŸç‰¹å¾æå–**ï¼š
$$
f_i = \frac{\sum_{j=1}^N m_{i,j} \cdot F_{S,j}}{\sum_{j=1}^N m_{i,j}} \in \mathbb{R}^d
$$

**DBSCANèšç±»**ï¼š
```python
def dbscan_clustering(features, eps=0.2, min_samples=1):
    # features: [Z, d] åŒºåŸŸç‰¹å¾
    # è®¡ç®—ç›¸ä¼¼åº¦çŸ©é˜µ
    similarities = cosine_similarity(features)
    
    # DBSCANèšç±»
    clusters = DBSCAN(eps=eps, min_samples=min_samples).fit(features)
    
    # åˆå¹¶æ©ç 
    merged_masks = []
    for cluster_id in set(clusters.labels_):
        if cluster_id == -1:  # å™ªå£°ç‚¹ï¼Œä¿ç•™åŸæ©ç 
            continue
        cluster_masks = [M[i] for i in range(Z) if clusters.labels_[i] == cluster_id]
        merged_mask = torch.stack(cluster_masks).max(dim=0)[0]  # é€»è¾‘æˆ–åˆå¹¶
        merged_masks.append(merged_mask)
    
    return merged_masks  # [z, N], z â‰¤ Z
```

### 2.3 äº¤äº’çŸ©é˜µæ„å»º

**æ•°å­¦å®šä¹‰**ï¼š
```math
$$
E = \underbrace{\sum_{i=1}^{z} \hat{m}_i \otimes \hat{m}_i}_{\text{åŒºåŸŸå†…éƒ¨äº¤äº’}} + \underbrace{(m_0 \otimes m_0) \odot (S > \text{Mean}(S))}_{\text{æœªåˆ†å‰²åŒºåŸŸäº¤äº’}}
$$
```
**è¯¦ç»†è§£é‡Š**ï¼š
- $\hat{m}_i \otimes \hat{m}_i$ï¼šå¤–ç§¯ï¼Œç”Ÿæˆ$N \times N$çŸ©é˜µï¼Œè¡¨ç¤ºåŒä¸€åŒºåŸŸå†…patchå¯äº¤äº’
- $m_0 = 1 - \sum_{i=1}^z \hat{m}_i$ï¼šæœªåˆ†å‰²åŒºåŸŸæ©ç 
- $S > \text{Mean}(S)$ï¼šç›¸ä¼¼åº¦é˜ˆå€¼è¿‡æ»¤ï¼Œåªå…è®¸é«˜ç›¸ä¼¼åº¦patchäº¤äº’

**ä»£ç å®ç°**ï¼š
```python
def build_interaction_matrix(merged_masks, similarity_matrix):
    """
    merged_masks: [z, N] åˆå¹¶åçš„æ©ç 
    similarity_matrix: [N, N] ç›¸ä¼¼åº¦çŸ©é˜µ
    """
    z, N = merged_masks.shape
    
    # åŒºåŸŸå†…éƒ¨äº¤äº’
    intra_interaction = torch.zeros(N, N)
    for i in range(z):
        mask = merged_masks[i]  # [N]
        intra_interaction += torch.outer(mask, mask)
    
    # æœªåˆ†å‰²åŒºåŸŸ
    unsegmented_mask = 1 - merged_masks.sum(dim=0)  # [N]
    similarity_threshold = similarity_matrix.mean()
    unsegmented_interaction = torch.outer(unsegmented_mask, unsegmented_mask)
    unsegmented_interaction = unsegmented_interaction * (similarity_matrix > similarity_threshold)
    
    # æ€»äº¤äº’çŸ©é˜µ
    E = intra_interaction + unsegmented_interaction
    return E  # [N, N], å€¼ä¸º0æˆ–1
```

## 3. ğŸ“Š å€¼é‡å»ºæ•°å­¦åŸç†

### 3.1 DINOç‰¹å¾æå–

DINOæ¨¡å‹åŒæ ·åŸºäºViTæ¶æ„ï¼Œä½†é€šè¿‡è‡ªç›‘ç£å­¦ä¹ è·å¾—æ›´å¥½çš„è¯­ä¹‰ä¸€è‡´æ€§ï¼š
```math
$$
Q_D, K_D, V_D = \text{DINO-ViT}(I) \in \mathbb{R}^{N \times d}
$$
```
### 3.2 æ”¹è¿›çš„ç›¸ä¼¼åº¦è®¡ç®—

**åŸå§‹CLIPç›¸ä¼¼åº¦**ï¼š
```math
$$
S_{CLIP} = Q_C Q_C^T
$$
```
**CorrCLIPç›¸ä¼¼åº¦**ï¼š
```math
$$
S = \frac{(Q_D + K_D)(Q_D + K_D)^T}{\|Q_D + K_D\|^2}
$$
```
**æ¸©åº¦é”åŒ–**ï¼š
```math
$$
Attn = \text{MaskedSoftmax}\left(\frac{S}{\tau}, E\right), \quad \tau = 0.25
$$
```
**æ•°å­¦æ„ä¹‰**ï¼š
- ä½¿ç”¨DINOçš„$Q_D + K_D$ä½œä¸ºæ›´é²æ£’çš„ç‰¹å¾è¡¨ç¤º
- L2å½’ä¸€åŒ–é¿å…æ•°å€¼ä¸ç¨³å®š
- æ¸©åº¦ç³»æ•°$\tau < 1$é”åŒ–åˆ†å¸ƒï¼Œå¢å¼ºé«˜ç›¸ä¼¼åº¦patchçš„æƒé‡

### 3.3 æ©ç æ³¨æ„åŠ›è®¡ç®—

```python
def masked_softmax(similarity_matrix, interaction_matrix, temperature=0.25):
    """
    similarity_matrix: [N, N]
    interaction_matrix: [N, N] (0æˆ–1)
    temperature: æ¸©åº¦ç³»æ•°
    """
    # åº”ç”¨æ©ç ï¼šä¸å…è®¸äº¤äº’çš„ä½ç½®è®¾ä¸ºè´Ÿæ— ç©·
    masked_similarity = similarity_matrix * interaction_matrix
    masked_similarity = masked_similarity + (interaction_matrix - 1) * 1e9
    
    # æ¸©åº¦ç¼©æ”¾å’Œsoftmax
    scaled_similarity = masked_similarity / temperature
    attention_weights = F.softmax(scaled_similarity, dim=-1)
    
    return attention_weights
```

## 4. ğŸ¨ ç‰¹å¾ç²¾ç‚¼è¯¦ç»†å®ç°

### 4.1 æ©ç ç±»åˆ«æ ‡è®°æœºåˆ¶

**æ•°å­¦è¡¨è¾¾**ï¼š
1. åœ¨ViTå¼€å§‹å¤„æ·»åŠ zä¸ªç‰¹æ®Štokenï¼š$[MCT_1, MCT_2, ..., MCT_z, Patch_1, ..., Patch_N]$
2. åœ¨æ³¨æ„åŠ›å±‚ä¸­ï¼Œæ¯ä¸ªMCTåªå…³æ³¨å¯¹åº”æ©ç å†…çš„patch
3. æœ€ç»ˆå°†æ¯ä¸ªpatchç‰¹å¾ä¸å¯¹åº”MCTç›¸åŠ 

**ä»£ç å®ç°**ï¼š
```python
class MaskClassTokens(nn.Module):
    def __init__(self, num_masks, dim):
        super().__init__()
        self.mct = nn.Parameter(torch.randn(num_masks, dim))
        
    def forward(self, patch_features, masks):
        """
        patch_features: [N, d]
        masks: [z, N] æ¯ä¸ªæ©ç å¯¹åº”å“ªäº›patch
        """
        # ä¸ºæ¯ä¸ªpatchæ‰¾åˆ°å¯¹åº”çš„MCT
        mask_assignments = masks.argmax(dim=0)  # [N] æ¯ä¸ªpatchå±äºå“ªä¸ªæ©ç 
        mct_features = self.mct[mask_assignments]  # [N, d]
        
        return mct_features
```

### 4.2 ç©ºé—´åˆ†æ”¯ç‰¹å¾èåˆ

**æµ…å±‚ç‰¹å¾æå–**ï¼š
è®¾$V_C'$ä¸ºCLIPæµ…å±‚ï¼ˆå¦‚ç¬¬6å±‚ï¼‰çš„valueç‰¹å¾ï¼Œç»è¿‡æœ€ç»ˆå±‚çš„å€¼æŠ•å½±ï¼š
```math
$$
V_{shallow} = \text{Proj}_{final}(V_C')
$$
```
**æœ€ç»ˆç‰¹å¾è®¡ç®—**ï¼š
```math
$$
F_{img} = \underbrace{\text{Proj}(Attn \cdot V_C)}_{\text{ä¸»åˆ†æ”¯}} + \alpha \cdot \underbrace{\text{Proj}(Attn \cdot V_{shallow})}_{\text{ç©ºé—´åˆ†æ”¯}} + \beta \cdot \underbrace{MCT}_{\text{è¯­ä¹‰åˆ†æ”¯}}
$$
```
å…¶ä¸­$\alpha = 1.0$, $\beta = 0.5$

## 5. ğŸ—ºï¸ åœ°å›¾æ ¡æ­£ç®—æ³•

### 5.1 ä¼—æ•°æŠ•ç¥¨ç­–ç•¥

å¯¹äºæ¯ä¸ªåŒºåŸŸ$\hat{m}_i$ï¼Œè®¡ç®—æœ€é¢‘ç¹çš„ç±»åˆ«ï¼š
```math
$$
\text{pred}[\hat{m}_i] = \text{Mode}(\text{pred}[\hat{m}_i])
$$
```
**å…·ä½“ç®—æ³•**ï¼š
```python
def map_correction(initial_pred, merged_masks):
    """
    initial_pred: [N] åˆå§‹é¢„æµ‹æ ‡ç­¾
    merged_masks: [z, N] åˆå¹¶åçš„æ©ç 
    """
    corrected_pred = initial_pred.clone()
    
    for i in range(len(merged_masks)):
        mask = merged_masks[i]  # [N]
        mask_indices = mask.nonzero().squeeze()  # æ©ç å†…patchç´¢å¼•
        
        if len(mask_indices) > 0:
            # è®¡ç®—åŒºåŸŸå†…æœ€é¢‘ç¹çš„ç±»åˆ«
            region_labels = initial_pred[mask_indices]
            most_common = torch.mode(region_labels).values
            corrected_pred[mask_indices] = most_common
    
    return corrected_pred
```

## 6. ğŸ§® å®Œæ•´å‰å‘ä¼ æ’­æµç¨‹

### 6.1 æ•°å­¦å…¬å¼æ±‡æ€»

1. **ç‰¹å¾æå–**ï¼š
```math
   $$
   Q_C, K_C, V_C = \text{CLIP-ViT}(I)
  
   Q_D, K_D, V_D = \text{DINO-ViT}(I)
   $$
```
2. **ç›¸ä¼¼åº¦è®¡ç®—**ï¼š
```math
   $$
   F_S = Q_D + K_D

   S = \frac{F_S F_S^T}{\|F_S\|^2}
   $$
```
3. **æ©ç ç”Ÿæˆä¸åˆå¹¶**ï¼š
```math
   $$
   M = \text{SAM}(I)

   \hat{M} = \text{Cluster}(M, F_{region})
   $$
```
4. **äº¤äº’çŸ©é˜µ**ï¼š
```math
   $$
   E = \sum_{i=1}^{z} \hat{m}_i \otimes \hat{m}_i + (m_0 \otimes m_0) \odot (S > \text{Mean}(S))
   $$
```
6. **æ³¨æ„åŠ›è®¡ç®—**ï¼š
  ```math
 $$
   Attn = \text{MaskedSoftmax}\left(\frac{S}{\tau}, E\right)
   $$
```
7. **ç‰¹å¾ç²¾ç‚¼**ï¼š
```math
   $$
   F_{img} = \text{Proj}(Attn V_C) + \alpha \cdot \text{Proj}(Attn V_{shallow}) + \beta \cdot MCT
   $$
```
9. **åˆ†å‰²é¢„æµ‹**ï¼š
```math
    $$
   \text{pred} = \arg\max_K(\text{Proj}(F_{img}) F_{text}^T)
   $$
```
11. **åœ°å›¾æ ¡æ­£**ï¼š
```math
$$
   \text{pred}[\hat{m}_i] = \text{Mode}(\text{pred}[\hat{m}_i]), \quad \forall i
   $$
```
### 6.2 è®¡ç®—å¤æ‚åº¦åˆ†æ

**ä¸»è¦è®¡ç®—ç“¶é¢ˆ**ï¼š
1. SAMæ©ç ç”Ÿæˆï¼š$O(HW \cdot \text{points})$
2. ç›¸ä¼¼åº¦çŸ©é˜µï¼š$O(N^2d)$ï¼Œå…¶ä¸­$N = \frac{HW}{P^2}$
3. æ©ç æ³¨æ„åŠ›ï¼š$O(N^2)$

**ä¼˜åŒ–æ€è·¯**ï¼š
- ç¨€ç–æ³¨æ„åŠ›æœºåˆ¶
- åˆ†å±‚ç›¸å…³æ€§è®¡ç®—
- è¿‘ä¼¼softmax

## 7. ğŸ”§ åŸºäºå½“å‰æŠ€æœ¯çš„æ”¹è¿›å»ºè®®

### 7.1 åŠ¨æ€æ¸©åº¦ç³»æ•°

```python
class AdaptiveTemperature(nn.Module):
    def __init__(self, base_temp=0.25):
        super().__init__()
        self.base_temp = base_temp
        self.temp_net = nn.Sequential(
            nn.Linear(d, 32),
            nn.ReLU(),
            nn.Linear(32, 1),
            nn.Sigmoid()
        )
        
    def forward(self, features):
        # åŸºäºç‰¹å¾å¤æ‚åº¦è‡ªé€‚åº”æ¸©åº¦
        feature_complexity = features.std(dim=-1).mean()
        adaptive_scale = self.temp_net(features.mean(dim=0))
        temperature = self.base_temp * adaptive_scale * (1 + feature_complexity)
        return temperature
```

### 7.2 å¤šå°ºåº¦ç›¸å…³æ€§èåˆ

```python
def multi_scale_correlation(features_scales, masks_scales):
    """
    features_scales: åˆ—è¡¨ï¼ŒåŒ…å«ä¸åŒå°ºåº¦çš„ç‰¹å¾
    masks_scales: åˆ—è¡¨ï¼ŒåŒ…å«ä¸åŒå°ºåº¦çš„æ©ç 
    """
    correlations = []
    for features, masks in zip(features_scales, masks_scales):
        # è®¡ç®—æ¯ä¸ªå°ºåº¦çš„ç›¸å…³æ€§
        scale_corr = compute_scale_correlation(features, masks)
        correlations.append(scale_corr)
    
    # è‡ªé€‚åº”æƒé‡èåˆ
    weights = compute_attention_weights(correlations)
    fused_correlation = sum(w * c for w, c in zip(weights, correlations))
    
    return fused_correlation
```

### 7.3 æ¸è¿›å¼æ©ç ç»†åŒ–

```python
def progressive_mask_refinement(initial_masks, features, num_steps=3):
    masks = initial_masks
    for step in range(num_steps):
        # åŸºäºå½“å‰ç‰¹å¾é‡æ–°è®¡ç®—åŒºåŸŸç›¸ä¼¼åº¦
        region_features = extract_region_features(features, masks)
        
        # åŠ¨æ€è°ƒæ•´èšç±»å‚æ•°
        eps = 0.2 * (1 - step/num_steps)  # é€æ¸æ”¶ç´§èšç±»æ¡ä»¶
        masks = adaptive_clustering(masks, region_features, eps)
    
    return masks
```

## ğŸ’ æ ¸å¿ƒåˆ›æ–°æ€»ç»“

CorrCLIPçš„æ ¸å¿ƒæ•°å­¦åˆ›æ–°åœ¨äºï¼š

1. **äº¤äº’çŸ©é˜µEçš„æ„å»º**ï¼šç³»ç»Ÿæ€§åœ°é™åˆ¶äº†è·¨ç±»åˆ«ç›¸å…³æ€§
2. **DINOå¢å¼ºçš„ç›¸ä¼¼åº¦è®¡ç®—**ï¼šæä¾›äº†æ›´è¯­ä¹‰ä¸€è‡´çš„ç‰¹å¾è¡¨ç¤º  
3. **å¤šåˆ†æ”¯ç‰¹å¾èåˆ**ï¼šå¹³è¡¡äº†ç©ºé—´ç»†èŠ‚å’Œè¯­ä¹‰ä¿¡æ¯
4. **ç«¯åˆ°ç«¯çš„è®­ç»ƒ-freeè®¾è®¡**ï¼šä¿æŒäº†CLIPçš„é›¶æ ·æœ¬èƒ½åŠ›

è¿™äº›æ•°å­¦ä¸Šçš„æ”¹è¿›ä½¿å¾—CLIPèƒ½å¤Ÿæ›´å¥½åœ°é€‚åº”å¯†é›†é¢„æµ‹ä»»åŠ¡ï¼Œä¸ºå¼€æ”¾è¯æ±‡è¯­ä¹‰åˆ†å‰²æä¾›äº†æ–°çš„æ€è·¯ã€‚


